<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3F Resinados - Sistema de Produção</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <link rel="icon" type="image/png" sizes="16x16" href="https://3fresinados.com.br/wp-content/uploads/2025/05/SVG-Icon-App-Producao.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://3fresinados.com.br/wp-content/uploads/2025/05/SVG-Icon-App-Producao.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://3fresinados.com.br/wp-content/uploads/2025/05/SVG-Icon-App-Producao.png">
    <link rel="shortcut icon" href="https://3fresinados.com.br/wp-content/uploads/2025/05/SVG-Icon-App-Producao.png">

    <style>
        :root {
            --brand-orange: #F37021; 
            --brand-dark: #1f2937; 
            --brand-medium: #6b7280; 
            --brand-light: #f8fafc; 
            --brand-border: #e2e8f0; 
            --brand-white: #ffffff;
            --text-primary: #0f172a; 
            --text-secondary: #64748b; 
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6; /* For informational toasts/notifications */
        }
        
        * { box-sizing: border-box; }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background-color: var(--brand-light); 
            color: var(--text-primary);
            font-weight: 400;
            line-height: 1.5;
        }
        
        /* Form Elements */
        .form-input, .form-select { 
            background-color: var(--brand-white); 
            border: 1px solid var(--brand-border); 
            color: var(--text-primary); 
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        .form-input:focus, .form-select:focus { 
            border-color: var(--brand-orange); 
            box-shadow: 0 0 0 3px rgba(243, 112, 33, 0.1); 
            outline: none; 
        }
        .form-input::placeholder { color: var(--text-secondary); }
        .form-checkbox { 
            width: 1.25rem; 
            height: 1.25rem; 
            border: 2px solid var(--brand-border);
            border-radius: 4px;
        }
        .form-checkbox:checked { 
            background-color: var(--brand-orange); 
            border-color: var(--brand-orange); 
        }
        
        /* Buttons */
        .btn { 
            padding: 0.75rem 1.5rem; 
            border-radius: 8px; 
            font-weight: 500; 
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            border: 1px solid transparent;
            cursor: pointer;
            text-decoration: none;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { 
            background-color: var(--brand-orange); 
            color: var(--brand-white); 
            border-color: var(--brand-orange); 
        }
        .btn-primary:hover:not(:disabled) { 
            background-color: #e5601a; 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(243, 112, 33, 0.3);
        }
        .btn-secondary { 
            background-color: var(--brand-white); 
            color: var(--text-primary); 
            border-color: var(--brand-border); 
        }
        .btn-secondary:hover:not(:disabled) { 
            background-color: #f1f5f9; 
            border-color: var(--brand-medium);
        }
        .btn-danger { 
            background-color: var(--danger);
            color: var(--brand-white);
            border-color: var(--danger);
        }
        .btn-danger:hover:not(:disabled) { 
            background-color: #dc2626; 
            transform: translateY(-1px);
        }
        .btn-sm { 
            padding: 0.5rem 1rem; 
            font-size: 0.8125rem; 
        }
        .btn-xs { 
            padding: 0.375rem 0.75rem; 
            font-size: 0.75rem; 
        }
        .btn-icon { 
            padding: 0.5rem; 
            width: 2.5rem;
            height: 2.5rem;
        }
        .btn-icon svg { width: 1rem; height: 1rem; }
        
        /* Header */
        .header { 
            background-color: var(--brand-white); 
            border-bottom: 1px solid var(--brand-border);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .header h1 { color: var(--brand-orange); font-weight: 600; }
        .header-logo { height: 32px; width: auto; margin-right: 0.75rem; }
        
        /* Navigation */
        .nav { 
            background-color: var(--brand-white); 
            border-bottom: 1px solid var(--brand-border);
        }
        .nav-link { 
            color: var(--text-secondary); 
            padding: 1rem 1.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .nav-link:hover { 
            color: var(--text-primary);
            background-color: #f8fafc;
        }
        .nav-link.active { 
            color: var(--brand-orange);
            border-bottom-color: var(--brand-orange);
        }
        
        /* Content Sections */
        .section-content { 
            background-color: var(--brand-white); 
            border: 1px solid var(--brand-border); 
            border-radius: 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-top: 1.5rem;
        }
        .section-content h2, .section-content h3 { 
            color: var(--text-primary); 
            font-weight: 600;
        }
        
        /* Status Badges */
        .status-badge { 
            padding: 0.25rem 0.75rem; 
            border-radius: 20px; 
            font-size: 0.75rem; 
            font-weight: 500; 
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }
        .status-ripando { background-color: #dbeafe; color: #1e40af; }
        .status-secagem { background-color: #e0f2f7; color: #0e7490; } 
        .status-impressao { background-color: #ede9fe; color: #7c3aed; }
        .status-recorte { background-color: #d1fae5; color: #059669; }
        .status-resina { background-color: #fae8ff; color: #c026d3; }
        .status-acabamento { background-color: #fce7f3; color: #db2777; }
        .status-embalagem { background-color: #fef3c7; color: #d97706; }
        .status-manager_review { background-color: #e0e7ff; color: #4338ca; }
        .status-pronto { background-color: #dcfce7; color: #16a34a; }
        .status-estimation { background-color: #fef3c7; color: #ca8a04; }
        
        .phase-estimation { background-color: #fff7ed; color: #ea580c; border: 1px solid #fed7aa; }
        .phase-manager_review { background-color: #f1f5f9; color: var(--text-primary); border: 1px solid var(--brand-border); }
        .phase-production { background-color: #dbeafe; color: #1d4ed8; border: 1px solid #bfdbfe; }
        .phase-completed { background-color: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
        
        .priority-normal { background-color: #f1f5f9; color: var(--text-secondary); }
        .priority-alta { background-color: #fff7ed; color: #ea580c; }
        .priority-urgente { 
            background-color: #fef2f2; 
            color: #dc2626;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        /* Cards */
        .card { 
            background-color: var(--brand-white); 
            border: 1px solid var(--brand-border); 
            border-radius: 12px; 
            padding: 1.5rem;
            transition: all 0.2s ease;
        }
        .card:hover { 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-1px);
        }
        .card-queue { 
            border-left: 4px solid var(--brand-border);
        }
        .card-queue.phase-estimation { border-left-color: var(--brand-orange); }
        .card-queue.phase-manager_review { border-left-color: #4338ca; }
        .card-queue.phase-production { border-left-color: #1d4ed8; }
        .card-queue.phase-completed { border-left-color: var(--success); }
        
        /* Table */
        table { border-collapse: collapse; }
        table thead { background-color: #f8fafc; }
        table th { 
            color: var(--text-primary); 
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.75rem 1rem;
        }
        table tbody { background-color: var(--brand-white); }
        table tr { border-bottom: 1px solid var(--brand-border); }
        table tr:hover { background-color: #f8fafc; }
        table td { 
            color: var(--text-secondary); 
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
        }
        
        /* Icons */
        .icon { width: 1rem; height: 1rem; }
        .icon-sm { width: 0.875rem; height: 0.875rem; }
        .icon-lg { width: 1.25rem; height: 1.25rem; }
        
        /* Modal */
        .modal-backdrop { 
            background-color: rgba(15, 23, 42, 0.7); 
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: var(--brand-white);
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }
        
        /* Loading */
        .loading-spinner {
            width: 2rem;
            height: 2rem;
            border: 2px solid var(--brand-border);
            border-top: 2px solid var(--brand-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
         .btn-loading-spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid var(--brand-white);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Utilities */
        .text-brand { color: var(--brand-orange); }
        .bg-brand { background-color: var(--brand-orange); }
        .border-brand { border-color: var(--brand-orange); }

        /* Calendar Styles */
        .calendar-container {
            background-color: var(--brand-white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .calendar-header h4 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem; /* Gap between cells */
        }
        .calendar-day-name {
            font-size: 0.75rem;
            font-weight: 500;
            text-align: center;
            color: var(--text-secondary);
            padding-bottom: 0.5rem;
        }
        .calendar-day {
            border: 1px solid var(--brand-border);
            border-radius: 8px;
            min-height: 6rem; /* Increased height */
            padding: 0.5rem;
            font-size: 0.875rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Align day number to top-left */
            justify-content: flex-start;
            transition: background-color 0.2s ease;
        }
        .calendar-day.other-month {
            color: var(--text-secondary);
            background-color: #f9fafb; /* Slightly different for other month days */
        }
        .calendar-day.today {
            background-color: var(--brand-orange);
            color: var(--brand-white);
            font-weight: 600;
        }
        .calendar-day.has-load {
            background-color: #fff7ed; /* Light orange for days with load */
            border-color: #fed7aa;
            cursor: pointer;
        }
        .calendar-day.has-load:hover {
            background-color: #feebc8; /* Darker orange on hover */
        }
        .calendar-day .day-number {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        .calendar-day .load-info {
            font-size: 0.75rem;
            color: var(--brand-orange);
            font-weight: 500;
        }
        
        /* Toast Notifications */
        #toastContainer {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .toast {
            background-color: var(--brand-dark);
            color: var(--brand-white);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            opacity: 0;
            transform: translateX(100%);
            animation: toastInRight 0.5s forwards, toastOutRight 0.5s 2.5s forwards;
        }
        .toast-success { background-color: var(--success); }
        .toast-error { background-color: var(--danger); }
        .toast-warning { background-color: var(--warning); color: var(--brand-dark); }
        .toast-info { background-color: var(--info); }
        .toast svg { width: 1.25rem; height: 1.25rem; }

        @keyframes toastInRight {
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes toastOutRight {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }

        /* Notification Bell & Dropdown */
        .notification-bell-container {
            position: relative;
        }
        .notification-count-badge {
            position: absolute;
            top: -0.25rem;
            right: -0.25rem;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid var(--brand-white);
        }
        #notificationDropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            width: 320px;
            max-height: 400px;
            overflow-y: auto;
            background-color: var(--brand-white);
            border: 1px solid var(--brand-border);
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            z-index: 50;
        }
        .notification-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--brand-border);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .notification-item:last-child {
            border-bottom: none;
        }
        .notification-item:hover {
            background-color: #f8fafc;
        }
        .notification-item.is-read {
            opacity: 0.7;
        }
        .notification-item p {
            font-size: 0.875rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        .notification-item small {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .notification-type-new_task { border-left: 3px solid var(--info); }
        .notification-type-estimate_needed { border-left: 3px solid var(--warning); }
        .notification-type-approval_needed { border-left: 3px solid var(--brand-orange); }
        .notification-type-order_update { border-left: 3px solid var(--success); }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .btn { padding: 0.625rem 1.25rem; }
            .nav-link { padding: 0.75rem 1rem; }
            .section-content { margin-top: 1rem; border-radius: 8px; }
            .calendar-day { min-height: 5rem; font-size: 0.75rem; }
            .calendar-header h4 { font-size: 1.125rem; }
            #toastContainer { top: 1rem; right: 1rem; left: 1rem; width: auto;}
            .toast { width: 100%; }
            #notificationDropdown { width: calc(100vw - 2rem); right: -1rem; }
        }
    </style>
</head>
<body class="min-h-screen">

    <header class="header">
        <div class="container mx-auto px-4 py-4 flex flex-wrap justify-between items-center">
            <div class="flex items-center">
                <img src="https://3fresinados.com.br/wp-content/uploads/2022/06/Logo-Oficial-Fundo-Branco-300x63.png" 
                     alt="3F Resinados" class="header-logo" 
                     onerror="this.style.display='none'; document.getElementById('headerTitleText').classList.remove('hidden');">
                <h1 id="headerTitleText" class="text-xl font-semibold hidden">Sistema de Produção</h1>
            </div>
            <div id="headerRightControls" class="flex items-center space-x-4 mt-2 md:mt-0">
                <div id="notificationBellContainer" class="notification-bell-container hidden">
                    <button id="notificationBellBtn" class="text-gray-500 hover:text-brand-orange transition-colors p-2">
                        <svg class="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                        <span id="notificationCountBadge" class="notification-count-badge hidden">0</span>
                    </button>
                    <div id="notificationDropdown" class="hidden shadow-lg">
                        <div class="flex justify-between items-center p-3 border-b border-gray-200">
                            <h4 class="text-sm font-semibold">Notificações</h4>
                            <button id="markAllNotificationsReadBtn" class="text-xs text-brand-orange hover:underline">Marcar todas como lidas</button>
                        </div>
                        <div id="notificationList" class="max-h-80 overflow-y-auto">
                           <p class="text-center text-gray-500 py-4 text-sm">Nenhuma notificação.</p>
                        </div>
                    </div>
                </div>
                <div id="userInfo" class="flex items-center space-x-2 hidden">
                    <span id="userNameDisplay" class="text-sm text-gray-600 font-medium"></span>
                    <button id="logoutBtn" class="btn btn-secondary btn-sm">Sair</button>
                </div>
            </div>
            <div id="authStatusContainerGlobal" class="text-xs text-gray-500 mt-2 md:mt-0">
                <span id="appIdDisplay" class="font-medium"></span> | <span id="authUserIdGlobal"></span>
            </div>
        </div>
    </header>

    <section id="loginSection" class="min-h-screen flex items-center justify-center p-4">
        <div class="card w-full max-w-md">
            <div class="text-center mb-8">
                <img src="https://3fresinados.com.br/wp-content/uploads/2022/06/Logo-Oficial-Fundo-Branco-300x63.png" 
                     alt="3F Resinados" class="mx-auto h-12 w-auto mb-4">
                <h2 class="text-2xl font-semibold text-gray-900 mb-2">Bem-vindo</h2>
                <p class="text-gray-600">Acesse o sistema de produção</p>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="loginEmail" class="form-input w-full" required>
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <input type="password" id="loginPassword" class="form-input w-full" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">Entrar</button>
            </form>
            <p id="loginError" class="text-red-500 text-sm mt-4 text-center hidden"></p>
        </div>
    </section>

    <div id="appContent" class="hidden">
        <nav class="nav">
            <div id="mainNavigation" class="container mx-auto px-4 flex overflow-x-auto">
                <button data-section="dashboard" id="navDashboardBtn" class="nav-link flex items-center gap-2 whitespace-nowrap">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Dashboard
                </button>
                <button data-section="estimatesControl" id="navEstimatesControlBtn" class="nav-link flex items-center gap-2 whitespace-nowrap">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                    </svg>
                    Controle Estimativas
                </button>
                <button data-section="newOrder" id="navNewOrderBtn" class="nav-link flex items-center gap-2 whitespace-nowrap">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Novo Pedido
                </button>
                <button data-section="myQueue" id="navMyQueueBtn" class="nav-link flex items-center gap-2 whitespace-nowrap">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                    </svg>
                    Minha Fila
                </button>
                <button data-section="allOrders" class="nav-link flex items-center gap-2 whitespace-nowrap">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    Pedidos
                </button>
                <button data-section="reports" class="nav-link flex items-center gap-2 whitespace-nowrap">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Relatórios
                </button>
                <button data-section="userManagement" id="navUserManagementBtn" class="nav-link flex items-center gap-2 whitespace-nowrap">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                    </svg>
                    Colaboradores
                </button>
            </div>
        </nav>

        <main class="container mx-auto px-4 pb-8">
            <section id="dashboardSection" class="section-content p-6">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
                    <h2 id="dashboardTitle" class="text-xl font-semibold">Dashboard de Tempos</h2>
                    <div class="flex items-center gap-3">
                        <input type="text" id="dashboardFilterInput" 
                               class="form-input" 
                               placeholder="Filtrar por ID ou Cliente...">
                        <button id="clearDashboardFilterBtn" class="btn btn-secondary btn-sm">Limpar</button>
                    </div>
                </div>
                <div id="timeDashboardContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="card text-center">
                        <div class="loading-spinner mx-auto mb-3"></div>
                        <p class="text-gray-500">Carregando dados...</p>
                    </div>
                </div>
            </section>

            <section id="estimatesControlSection" class="section-content hidden p-6">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
                    <h2 class="text-xl font-semibold">Controle de Estimativas</h2>
                    <div class="flex items-center gap-3">
                        <input type="text" id="estimatesControlFilterInput" 
                               class="form-input" 
                               placeholder="Filtrar por ID ou Cliente...">
                        <button id="clearEstimatesControlFilterBtn" class="btn btn-secondary btn-sm">Limpar</button>
                    </div>
                </div>
                <div id="estimatesControlContainer">
                    <div class="card text-center">
                        <div class="loading-spinner mx-auto mb-3"></div>
                        <p class="text-gray-500">Carregando controle de estimativas...</p>
                    </div>
                </div>
            </section>

            <section id="newOrderSection" class="section-content hidden p-6">
                <h2 class="text-xl font-semibold mb-6">Criar Novo Pedido</h2>
                <form id="orderForm" class="space-y-8">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <label for="clientName" class="block text-sm font-medium text-gray-700 mb-2">Nome do Cliente</label>
                            <input type="text" id="clientName" class="form-input w-full" required>
                        </div>
                        <div>
                            <label for="deliveryDate" class="block text-sm font-medium text-gray-700 mb-2">Data de Entrega</label>
                            <input type="date" id="deliveryDate" class="form-input w-full" required>
                        </div>
                        <div>
                            <label for="priority" class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                            <select id="priority" class="form-select w-full">
                                <option value="normal">Normal</option>
                                <option value="alta">Alta</option>
                                <option value="urgente">Urgente</option>
                            </select>
                        </div>
                        <div>
                            <label for="coverImageUrl" class="block text-sm font-medium text-gray-700 mb-2">URL da Imagem</label>
                            <input type="url" id="coverImageUrl" class="form-input w-full" placeholder="https://exemplo.com/imagem.png">
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-medium mb-4">Itens do Pedido</h3>
                        <div id="orderItemsContainer" class="space-y-4"></div>
                        <button type="button" id="addOrderItemBtn" class="btn btn-secondary btn-sm mt-4">
                            <svg class="icon-sm mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            Adicionar Item
                        </button>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-medium mb-4">Etapas de Produção</h3>
                        <div id="productionStagesCheckboxes" class="grid grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    </div>

                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                        <textarea id="description" rows="3" class="form-input w-full" placeholder="Detalhes do pedido..."></textarea>
                         <button type="button" id="generateDescriptionBtn" class="btn btn-secondary btn-sm mt-2 hidden">
                            <span class="btn-text">✨ Gerar Descrição Inteligente</span>
                            <span class="btn-loading-spinner hidden"></span>
                        </button>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <svg class="icon-sm mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                        </svg>
                        Iniciar Coleta de Estimativas
                    </button>
                </form>
            </section>

            <section id="myQueueSection" class="section-content hidden p-6">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
                    <h2 id="myQueueTitle" class="text-xl font-semibold">Minha Fila de Trabalho</h2>
                    <div class="flex items-center gap-3">
                        <input type="text" id="myQueueFilterInput" 
                               class="form-input" 
                               placeholder="Filtrar...">
                        <button id="clearMyQueueFilterBtn" class="btn btn-secondary btn-sm">Limpar</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-lg font-medium mb-4 pb-2 border-b border-gray-200 flex items-center gap-2">
                            <svg class="icon text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Aguardando Estimativa
                        </h3>
                        <div id="myQueueEstimationList" class="space-y-4">
                            <p class="text-gray-500">Nenhum pedido aguardando sua estimativa.</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium mb-4 pb-2 border-b border-gray-200 flex items-center gap-2">
                            <svg class="icon text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            Em Produção / Revisão
                        </h3>
                        <div id="myQueueProductionList" class="space-y-4">
                            <p class="text-gray-500">Nenhum pedido em produção.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="allOrdersSection" class="section-content hidden p-6">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
                    <h2 class="text-xl font-semibold">Todos os Pedidos</h2>
                    <div class="flex items-center gap-3">
                        <input type="text" id="orderFilterInput" 
                               class="form-input" 
                               placeholder="Filtrar por ID ou Cliente...">
                        <button id="clearOrderFilterBtn" class="btn btn-secondary btn-sm">Limpar</button>
                         <button id="toggleOrderSelectionModeBtn" class="btn btn-warning btn-sm hidden">Selecionar para Excluir</button>
                        <button id="deleteSelectedOrdersBtn" class="btn btn-danger btn-sm hidden">Excluir Selecionados</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th class="text-center w-12 order-select-th hidden">Sel.</th>
                                <th class="text-left">ID</th>
                                <th class="text-left">Cliente</th>
                                <th class="text-left">Itens</th>
                                <th class="text-left">Fase</th>
                                <th class="text-left">Status</th>
                                <th class="text-left">Criado em</th> <th class="text-left">Início Prod.</th>
                                <th class="text-left">Entrega</th>
                                <th class="text-left">Prioridade</th>
                                <th class="text-left">T. Estimado</th>
                                <th class="text-left">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="allOrdersTableBody">
                            <tr>
                                <td colspan="12" class="text-center py-8 text-gray-500">
                                    Nenhum pedido cadastrado.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="reportsSection" class="section-content hidden p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold">Relatórios de Produção</h2>
                    <div class="flex gap-2">
                        <button id="reportViewListBtn" class="btn btn-secondary btn-sm">Lista</button>
                        <button id="reportViewCalendarBtn" class="btn btn-secondary btn-sm">Calendário</button>
                    </div>
                </div>
                
                <div id="dailyLoadReportListContainer">
                    <h3 class="text-lg font-medium mb-4 flex items-center gap-2">
                        <svg class="icon text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a4 4 0 118 0v4M5 21h14a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2z"/>
                        </svg>
                        Carga de Produção por Dia (Lista)
                    </h3>
                    <div id="dailyLoadReportContainer" class="space-y-3">
                        <div class="card text-center">
                            <div class="loading-spinner mx-auto mb-3"></div>
                            <p class="text-gray-500">Calculando carga...</p>
                        </div>
                    </div>
                </div>

                <div id="calendarViewContainer" class="calendar-container hidden mt-6">
                     <div class="flex justify-center items-center mb-4 gap-4" id="calendarModeToggleContainer">
                        <span class="text-sm font-medium text-gray-700">Visualizar Calendário Por:</span>
                        <button id="calendarModeDeliveryBtn" class="btn btn-primary btn-xs">Data de Entrega</button>
                        <button id="calendarModeProductionBtn" class="btn btn-secondary btn-xs">Data de Produção</button>
                    </div>
                    <div class="calendar-header">
                        <button id="prevMonthBtn" class="btn btn-secondary btn-icon">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        </button>
                        <h4 id="calendarMonthYear"></h4>
                        <button id="nextMonthBtn" class="btn btn-secondary btn-icon">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </button>
                    </div>
                    <div class="calendar-grid" id="calendarDaysNames">
                        </div>
                    <div class="calendar-grid" id="calendarDaysGrid">
                        </div>
                </div>
            </section>

            <section id="userManagementSection" class="section-content hidden p-6">
                <h2 class="text-xl font-semibold mb-6">Gestão de Colaboradores</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-lg font-medium mb-4">Adicionar Colaborador</h3>
                        <form id="addCollaboratorForm" class="space-y-4">
                            <div>
                                <label for="collabName" class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                                <input type="text" id="collabName" class="form-input w-full" required>
                            </div>
                            <div>
                                <label for="collabEmail" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" id="collabEmail" class="form-input w-full" required>
                            </div>
                            <div>
                                <label for="collabPassword" class="block text-sm font-medium text-gray-700 mb-2">Senha Inicial</label>
                                <input type="password" id="collabPassword" class="form-input w-full" required minlength="6">
                            </div>
                            <div>
                                <label for="collabRole" class="block text-sm font-medium text-gray-700 mb-2">Função</label>
                                <select id="collabRole" class="form-select w-full">
                                    <option value="employee">Colaborador</option>
                                    <option value="manager">Gerente</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-3">Departamentos</label>
                                <div id="collabStagesCheckboxes" class="grid grid-cols-2 gap-3"></div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <svg class="icon-sm mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                                </svg>
                                Adicionar
                            </button>
                        </form>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium mb-4">Colaboradores Cadastrados</h3>
                        <div id="collaboratorsList" class="space-y-3">
                            <p class="text-gray-500">Nenhum colaborador cadastrado.</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="genericModal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 id="genericModalTitle" class="text-lg font-semibold">Modal</h3>
                <button onclick="closeGenericModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="genericModalBody">
                <p id="genericModalMessage" class="text-gray-600 mb-6">Mensagem.</p>
            </div>
            <div id="genericModalActions" class="flex justify-end gap-3">
                <button onclick="closeGenericModal()" class="btn btn-secondary btn-sm">Fechar</button>
            </div>
        </div>
    </div>

    <div id="imagePreviewModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-60 hidden">
        <div class="relative">
            <button onclick="closeImagePreviewModal()" 
                    class="absolute -top-12 right-0 text-white hover:text-gray-300 transition-colors">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            <img id="previewImageSrc" src="" alt="Preview" class="max-w-full max-h-[80vh] rounded-lg">
        </div>
    </div>

    <div id="orderDetailsReportModal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 hidden overflow-y-auto">
        <div class="modal-content p-6 w-full max-w-3xl max-h-[90vh] flex flex-col bg-white rounded-xl shadow-2xl">
            <div class="flex justify-between items-center mb-6 border-b border-gray-200 pb-4">
                <h3 id="orderDetailsReportModalTitle" class="text-xl font-semibold text-brand-orange">Relatório Detalhado do Pedido</h3>
                <button onclick="closeOrderDetailsReportModal()" class="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-full hover:bg-gray-100">
                    <svg class="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="orderDetailsReportModalBody" class="space-y-6 overflow-y-auto pr-2 flex-grow">
                <div class="bg-slate-50 p-4 rounded-lg shadow-sm">
                    <h4 class="text-lg font-semibold mb-3 text-gray-800 border-b pb-2">Informações do Pedido</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3 text-sm">
                        <div><strong class="text-gray-600">Cliente:</strong> <span id="reportClientName" class="text-gray-900"></span></div>
                        <div><strong class="text-gray-600">Pedido ID:</strong> <span id="reportOrderId" class="text-gray-900 font-mono text-xs"></span></div>
                        <div><strong class="text-gray-600">Criado em:</strong> <span id="reportCreatedAt" class="text-gray-900"></span></div> <div><strong class="text-gray-600">Início Produção:</strong> <span id="reportProductionStartDate" class="text-gray-900"></span></div>
                        <div><strong class="text-gray-600">Data Entrega:</strong> <span id="reportDeliveryDate" class="text-gray-900"></span></div>
                        <div><strong class="text-gray-600">Prioridade:</strong> <span id="reportPriority" class="text-gray-900"></span></div>
                        <div><strong class="text-gray-600">Fase Atual:</strong> <span id="reportOrderPhase" class="text-gray-900"></span></div>
                        <div class="md:col-span-2"><strong class="text-gray-600">Status:</strong> <span id="reportOrderStatus" class="text-gray-900"></span></div>
                    </div>
                </div>

                <div class="mt-4 bg-slate-50 p-4 rounded-lg shadow-sm">
                    <h4 class="text-lg font-semibold mb-3 text-gray-800 border-b pb-2">Imagem de Referência</h4>
                    <div class="flex justify-center items-center">
                        <img id="reportCoverImage" src="" alt="Imagem de Referência do Pedido" class="max-w-md max-h-80 rounded-md border border-gray-200 shadow-sm hidden object-contain">
                        <p id="reportCoverImageError" class="text-gray-500 text-sm hidden italic">Nenhuma imagem fornecida ou falha ao carregar.</p>
                    </div>
                </div>

                <div class="mt-4 bg-slate-50 p-4 rounded-lg shadow-sm">
                    <h4 class="text-lg font-semibold mb-3 text-gray-800 border-b pb-2">Itens do Pedido</h4>
                    <div id="reportOrderItems" class="space-y-2 text-sm"></div>
                </div>

                <div class="mt-4 bg-slate-50 p-4 rounded-lg shadow-sm">
                    <h4 class="text-lg font-semibold mb-3 text-gray-800 border-b pb-2">Etapas de Produção Selecionadas</h4>
                    <ul id="reportSelectedStages" class="list-disc list-inside text-sm space-y-1 pl-5"></ul>
                </div>

                <div class="mt-4 bg-slate-50 p-4 rounded-lg shadow-sm">
                    <h4 class="text-lg font-semibold mb-3 text-gray-800 border-b pb-2">Observações Gerais (Pedido)</h4>
                    <p id="reportDescription" class="text-sm text-gray-700 whitespace-pre-wrap"></p>
                </div>
                
                <div class="mt-4 bg-slate-50 p-4 rounded-lg shadow-sm">
                    <h4 class="text-lg font-semibold mb-3 text-gray-800 border-b pb-2">Timeline Detalhada</h4>
                    <div id="reportDetailedTimeline" class="space-y-4 text-sm"></div>
                </div>

                <div class="mt-4 bg-slate-50 p-4 rounded-lg shadow-sm">
                    <h4 class="text-lg font-semibold mb-3 text-gray-800 border-b pb-2">Controle de Qualidade (para preenchimento)</h4>
                    <div id="reportQualityControlTable" class="overflow-x-auto">
                        <table class="min-w-full text-sm border border-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 border border-gray-300 text-left">Item</th>
                                    <th class="p-2 border border-gray-300 text-left">Responsável</th>
                                    <th class="p-2 border border-gray-300 text-center">OK</th>
                                    <th class="p-2 border border-gray-300 text-center">NOK</th>
                                    <th class="p-2 border border-gray-300 text-left">Observações</th>
                                </tr>
                            </thead>
                            <tbody id="reportQCTableBody" class="bg-white">
                                </tbody>
                        </table>
                        <div class="mt-3">
                            <p class="font-medium text-gray-700 mb-1">Observações Manuais (Controle de Qualidade):</p>
                            <div class="border border-gray-300 rounded-md p-2 h-24 bg-gray-50 text-gray-400 italic">Espaço para anotações...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="orderDetailsReportModalActions" class="mt-6 pt-4 border-t border-gray-200 flex justify-end gap-3">
                <button onclick="closeOrderDetailsReportModal()" class="btn btn-secondary">Fechar</button>
            </div>
        </div>
    </div>

    <div id="dailyLoadDetailsModal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 hidden overflow-y-auto">
        <div class="modal-content p-6 w-full max-w-2xl max-h-[80vh] flex flex-col bg-white rounded-xl shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b border-gray-200 pb-3">
                <h3 id="dailyLoadDetailsModalTitle" class="text-lg font-semibold text-brand-orange">Pedidos para o Dia</h3>
                <button onclick="closeDailyLoadDetailsModal()" class="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-full hover:bg-gray-100">
                    <svg class="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="dailyLoadDetailsModalBody" class="space-y-3 overflow-y-auto pr-2 flex-grow">
                <p class="text-gray-500 italic">Carregando detalhes dos pedidos...</p>
            </div>
            <div class="mt-4 pt-3 border-t border-gray-200 flex justify-end">
                <button onclick="closeDailyLoadDetailsModal()" class="btn btn-secondary btn-sm">Fechar</button>
            </div>
        </div>
    </div>

    <div id="editOrderDatesModal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content p-6 w-full max-w-lg bg-white rounded-xl shadow-2xl">
            <div class="flex justify-between items-center mb-6 border-b border-gray-200 pb-4">
                <h3 class="text-xl font-semibold text-brand-orange">Editar Datas do Pedido</h3>
                <button onclick="closeEditOrderDatesModal()" class="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-full hover:bg-gray-100">
                    <svg class="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="editOrderDatesForm" class="space-y-4">
                <input type="hidden" id="editOrderId">
                <div>
                    <label for="editProductionStartDate" class="block text-sm font-medium text-gray-700 mb-1">Nova Data de Início da Produção:</label>
                    <input type="date" id="editProductionStartDate" class="form-input w-full">
                </div>
                <div>
                    <label for="editDeliveryDate" class="block text-sm font-medium text-gray-700 mb-1">Nova Data de Entrega:</label>
                    <input type="date" id="editDeliveryDate" class="form-input w-full">
                </div>
            </form>
            <div class="mt-6 pt-4 border-t border-gray-200 flex justify-end gap-3">
                <button type="button" onclick="closeEditOrderDatesModal()" class="btn btn-secondary">Cancelar</button>
                <button type="button" id="saveOrderDatesBtn" class="btn btn-primary">Salvar Alterações</button>
            </div>
        </div>
    </div>
    
    <div id="editCollaboratorModal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content p-6 w-full max-w-lg bg-white rounded-xl shadow-2xl">
            <div class="flex justify-between items-center mb-6 border-b border-gray-200 pb-4">
                <h3 class="text-xl font-semibold text-brand-orange">Editar Colaborador</h3>
                <button onclick="closeEditCollaboratorModal()" class="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-full hover:bg-gray-100">
                    <svg class="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="editCollaboratorForm" class="space-y-4">
                <input type="hidden" id="editCollaboratorId">
                <div>
                    <label for="editCollabName" class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
                    <input type="text" id="editCollabName" class="form-input w-full" required>
                </div>
                <div>
                    <label for="editCollabEmail" class="block text-sm font-medium text-gray-700 mb-1">Email (não editável)</label>
                    <input type="email" id="editCollabEmail" class="form-input w-full bg-gray-100" readonly>
                </div>
                <div>
                    <label for="editCollabRole" class="block text-sm font-medium text-gray-700 mb-1">Função</label>
                    <select id="editCollabRole" class="form-select w-full">
                        <option value="employee">Colaborador</option>
                        <option value="manager">Gerente</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Departamentos</label>
                    <div id="editCollabStagesCheckboxes" class="grid grid-cols-2 gap-3">
                        </div>
                </div>
            </form>
            <div class="mt-6 pt-4 border-t border-gray-200 flex justify-end gap-3">
                <button type="button" onclick="closeEditCollaboratorModal()" class="btn btn-secondary">Cancelar</button>
                <button type="button" id="saveCollaboratorChangesBtn" class="btn btn-primary">Salvar Alterações</button>
            </div>
        </div>
    </div>


    <div id="loadingIndicator" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 flex items-center gap-4">
            <div class="loading-spinner"></div>
            <p class="font-medium">Processando...</p>
        </div>
    </div>
    
    <div id="toastContainer"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            setDoc, 
            getDoc,
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            query, 
            where,
            orderBy,
            serverTimestamp, // Import for server-side timestamps
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { jsPDF } = window.jspdf;

        // IMPORTANTE: Substitua esta string pela string Base64 da sua logo!
        const COMPANY_LOGO_BASE64 = "COLE_AQUI_A_STRING_BASE64_DA_SUA_LOGO"; 
        
        // Configuração do Firebase 
        const firebaseConfig = {
            apiKey: "AIzaSyCcdNZidSeOxy2A2uyl7Rbgv2_cMMKBNzQ", // Substitua pela sua API Key real
            authDomain: "sistema-producao-3f.firebaseapp.com",
            projectId: "sistema-producao-3f",
            storageBucket: "sistema-producao-3f.firebasestorage.app", 
            messagingSenderId: "568820985788",
            appId: "1:568820985788:web:f523e97bab8fbf8b27c5b9"
        };
        
        const internalAppId = '3f-producao-app'; 
        
        const appIdDisplayEl = document.getElementById('appIdDisplay');
        if (appIdDisplayEl) appIdDisplayEl.textContent = internalAppId;

        const fbApp = initializeApp(firebaseConfig);
        const db = getFirestore(fbApp);
        const auth = getAuth(fbApp);
        setLogLevel('debug'); 

        let currentAuthUser = null; 
        let currentUserProfile = null; 
        let ordersCollectionRef = null;
        let collaboratorsCollectionRef = null;
        let notificationsCollectionRef = null; // New collection ref
        let unsubscribeOrders = null;
        let unsubscribeCollaborators = null;
        let unsubscribeNotifications = null; // For notification listener
        let allOrdersCache = [];
        let allCollaboratorsCache = [];
        let userNotificationsCache = []; // Cache for user's notifications
        let dailyLoadCache = {}; 
        let currentCalendarDate = new Date(); 
        let isOrderSelectionModeActive = false; 
        let selectedOrdersForDeletion = new Set(); 
        let currentReportCalendarType = 'delivery'; // 'delivery' ou 'production'


        const ALL_POSSIBLE_STAGES = [ 
            { key: 'ripando', name: 'Ripando' }, 
            { key: 'secagem', name: 'Secagem' }, 
            { key: 'impressao', name: 'Impressão' },
            { key: 'recorte', name: 'Recorte' }, 
            { key: 'resina', name: 'Resina' }, 
            { key: 'acabamento', name: 'Acabamento' },
            { key: 'embalagem', name: 'Embalagem' }
        ];
        const MANAGER_ROLE = 'manager';
        const EMPLOYEE_ROLE = 'employee';
        const MANAGER_REVIEW_STAGE_KEY = 'manager_review'; 
        const COMPLETED_STAGE_KEY = 'pronto';
        
        const STATUS_TEXT_MAP = {
            ripando: 'Ripando', 
            secagem: 'Secagem', 
            impressao: 'Impressão', 
            recorte: 'Recorte', 
            resina: 'Resina',
            acabamento: 'Acabamento', 
            embalagem: 'Embalagem',
            [MANAGER_REVIEW_STAGE_KEY]: 'Revisão Gerente', 
            [COMPLETED_STAGE_KEY]: 'Pronto',
            estimation: 'Coletando Estimativas' 
        };
        
        const ORDER_PHASE_TEXT_MAP = {
            estimation: 'Estimativa',
            manager_review: 'Revisão Gerente',
            production: 'Produção',
            completed: 'Concluído'
        };

        // Elementos da UI
        const loginSectionEl = document.getElementById('loginSection');
        const appContentEl = document.getElementById('appContent');
        const loginFormEl = document.getElementById('loginForm');
        const loginErrorEl = document.getElementById('loginError');
        const userInfoEl = document.getElementById('userInfo');
        const userNameDisplayEl = document.getElementById('userNameDisplay');
        const logoutBtnEl = document.getElementById('logoutBtn');
        const authStatusContainerGlobalEl = document.getElementById('authStatusContainerGlobal');
        const authUserIdGlobalEl = document.getElementById('authUserIdGlobal');
        const navDashboardBtnEl = document.getElementById('navDashboardBtn'); 
        const navEstimatesControlBtnEl = document.getElementById('navEstimatesControlBtn');
        const navNewOrderBtnEl = document.getElementById('navNewOrderBtn'); 
        const navUserManagementBtnEl = document.getElementById('navUserManagementBtn');
        const navMyQueueBtnEl = document.getElementById('navMyQueueBtn'); 
        
        const orderFormEl = document.getElementById('orderForm');
        const allOrdersTableBodyEl = document.getElementById('allOrdersTableBody');
        const myQueueEstimationListEl = document.getElementById('myQueueEstimationList'); 
        const myQueueProductionListEl = document.getElementById('myQueueProductionList'); 
        const myQueueTitleEl = document.getElementById('myQueueTitle');
        const loadingIndicatorEl = document.getElementById('loadingIndicator');
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.section-content');
        const timeDashboardContainerEl = document.getElementById('timeDashboardContainer');
        const orderFilterInputEl = document.getElementById('orderFilterInput');
        const clearOrderFilterBtnEl = document.getElementById('clearOrderFilterBtn');
        const dashboardFilterInputEl = document.getElementById('dashboardFilterInput');
        const clearDashboardFilterBtnEl = document.getElementById('clearDashboardFilterBtn');
        const dashboardTitleEl = document.getElementById('dashboardTitle');
        const productionStagesCheckboxesEl = document.getElementById('productionStagesCheckboxes');
        const imagePreviewModalEl = document.getElementById('imagePreviewModal');
        const previewImageSrcEl = document.getElementById('previewImageSrc');
        const orderItemsContainerEl = document.getElementById('orderItemsContainer');
        const addOrderItemBtnEl = document.getElementById('addOrderItemBtn');
        const dailyLoadReportContainerEl = document.getElementById('dailyLoadReportContainer');
        const myQueueFilterInputEl = document.getElementById('myQueueFilterInput'); 
        const clearMyQueueFilterBtnEl = document.getElementById('clearMyQueueFilterBtn'); 
        const addCollaboratorFormEl = document.getElementById('addCollaboratorForm');
        const collabStagesCheckboxesEl = document.getElementById('collabStagesCheckboxes');
        const collaboratorsListEl = document.getElementById('collaboratorsList');
        const estimatesControlContainerEl = document.getElementById('estimatesControlContainer');
        const estimatesControlFilterInputEl = document.getElementById('estimatesControlFilterInput');
        const clearEstimatesControlFilterBtnEl = document.getElementById('clearEstimatesControlFilterBtn');
        const generateDescriptionBtnEl = document.getElementById('generateDescriptionBtn');
        const descriptionTextAreaEl = document.getElementById('description');


        // Elementos do Modal de Relatório de Pedido
        const orderDetailsReportModalEl = document.getElementById('orderDetailsReportModal');
        const reportClientNameEl = document.getElementById('reportClientName');
        const reportOrderIdEl = document.getElementById('reportOrderId');
        const reportCreatedAtEl = document.getElementById('reportCreatedAt');
        const reportProductionStartDateEl = document.getElementById('reportProductionStartDate'); 
        const reportDeliveryDateEl = document.getElementById('reportDeliveryDate');
        const reportPriorityEl = document.getElementById('reportPriority');
        const reportOrderPhaseEl = document.getElementById('reportOrderPhase');
        const reportOrderStatusEl = document.getElementById('reportOrderStatus');
        const reportCoverImageEl = document.getElementById('reportCoverImage');
        const reportCoverImageErrorEl = document.getElementById('reportCoverImageError');
        const reportOrderItemsEl = document.getElementById('reportOrderItems');
        const reportSelectedStagesEl = document.getElementById('reportSelectedStages');
        const reportDescriptionEl = document.getElementById('reportDescription');
        const reportDetailedTimelineEl = document.getElementById('reportDetailedTimeline');
        const reportQCTableBodyEl = document.getElementById('reportQCTableBody');

        // Elementos do Modal de Detalhes da Carga Diária
        const dailyLoadDetailsModalEl = document.getElementById('dailyLoadDetailsModal');
        const dailyLoadDetailsModalTitleEl = document.getElementById('dailyLoadDetailsModalTitle');
        const dailyLoadDetailsModalBodyEl = document.getElementById('dailyLoadDetailsModalBody');

        // Elementos do Relatório de Calendário
        const reportViewListBtnEl = document.getElementById('reportViewListBtn');
        const reportViewCalendarBtnEl = document.getElementById('reportViewCalendarBtn');
        const dailyLoadReportListContainerEl = document.getElementById('dailyLoadReportListContainer');
        const calendarViewContainerEl = document.getElementById('calendarViewContainer');
        const calendarMonthYearEl = document.getElementById('calendarMonthYear');
        const prevMonthBtnEl = document.getElementById('prevMonthBtn');
        const nextMonthBtnEl = document.getElementById('nextMonthBtn');
        const calendarDaysNamesEl = document.getElementById('calendarDaysNames');
        const calendarDaysGridEl = document.getElementById('calendarDaysGrid');
        const calendarModeToggleContainerEl = document.getElementById('calendarModeToggleContainer');
        const calendarModeDeliveryBtnEl = document.getElementById('calendarModeDeliveryBtn');
        const calendarModeProductionBtnEl = document.getElementById('calendarModeProductionBtn');


        // Botões de exclusão em massa
        const toggleOrderSelectionModeBtnEl = document.getElementById('toggleOrderSelectionModeBtn');
        const deleteSelectedOrdersBtnEl = document.getElementById('deleteSelectedOrdersBtn');

        // Elementos do Modal de Edição de Datas
        const editOrderDatesModalEl = document.getElementById('editOrderDatesModal');
        const editOrderIdInputEl = document.getElementById('editOrderId');
        const editProductionStartDateInputEl = document.getElementById('editProductionStartDate');
        const editDeliveryDateInputEl = document.getElementById('editDeliveryDate');
        const saveOrderDatesBtnEl = document.getElementById('saveOrderDatesBtn');

        // Elementos do Modal de Edição de Colaborador
        const editCollaboratorModalEl = document.getElementById('editCollaboratorModal');
        const editCollaboratorIdInputEl = document.getElementById('editCollaboratorId');
        const editCollabNameInputEl = document.getElementById('editCollabName');
        const editCollabEmailInputEl = document.getElementById('editCollabEmail');
        const editCollabRoleSelectEl = document.getElementById('editCollabRole');
        const editCollabStagesCheckboxesEl = document.getElementById('editCollabStagesCheckboxes');
        const saveCollaboratorChangesBtnEl = document.getElementById('saveCollaboratorChangesBtn');
        
        // Elementos de Notificação
        const toastContainerEl = document.getElementById('toastContainer');
        const notificationBellContainerEl = document.getElementById('notificationBellContainer');
        const notificationBellBtnEl = document.getElementById('notificationBellBtn');
        const notificationCountBadgeEl = document.getElementById('notificationCountBadge');
        const notificationDropdownEl = document.getElementById('notificationDropdown');
        const notificationListEl = document.getElementById('notificationList');
        const markAllNotificationsReadBtnEl = document.getElementById('markAllNotificationsReadBtn');
        
        // --- Notification System Functions ---
        function showToast(message, type = 'info', duration = 3000) {
            if (!toastContainerEl) return;

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            let iconSvg = '';
            if (type === 'success') iconSvg = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`;
            else if (type === 'error') iconSvg = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`;
            else if (type === 'warning') iconSvg = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`;
            else iconSvg = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`;

            toast.innerHTML = `${iconSvg}<span>${message}</span>`;
            toastContainerEl.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, duration + 500); // +500ms for animation out
        }

        async function createNotification(targetUserId, message, orderId = null, sectionTarget = null, type = 'info') {
            if (!targetUserId || !message) {
                console.warn("createNotification: targetUserId ou message faltando.");
                return;
            }
            if (!notificationsCollectionRef) {
                 console.error("createNotification: notificationsCollectionRef não está definido.");
                return;
            }
            try {
                await addDoc(notificationsCollectionRef, {
                    appId: internalAppId,
                    userId: targetUserId,
                    message: message,
                    orderId: orderId,
                    sectionTarget: sectionTarget, // e.g., 'myQueue' or 'allOrders'
                    type: type, // e.g., 'new_task', 'approval_needed'
                    createdAt: serverTimestamp(),
                    isRead: false
                });
                console.log(`[DEBUG] Notificação criada para ${targetUserId}: ${message}`);
            } catch (error) {
                console.error("Erro ao criar notificação:", error);
            }
        }
        
        function listenForNotifications() {
            if (unsubscribeNotifications) unsubscribeNotifications();
            if (!currentAuthUser || !notificationsCollectionRef) return;

            const q = query(
                notificationsCollectionRef,
                where("appId", "==", internalAppId),
                where("userId", "==", currentAuthUser.uid),
                orderBy("createdAt", "desc")
            );

            unsubscribeNotifications = onSnapshot(q, (querySnapshot) => {
                userNotificationsCache = [];
                querySnapshot.forEach(doc => {
                    userNotificationsCache.push({ id: doc.id, ...doc.data() });
                });
                renderNotificationDropdown(userNotificationsCache);
                updateNotificationBadge(userNotificationsCache);
            }, (error) => {
                console.error("Erro ao ouvir notificações:", error);
                showToast("Erro ao carregar notificações.", "error");
            });
        }

        function updateNotificationBadge(notifications) {
             if (!notificationCountBadgeEl || !notificationBellContainerEl) return;
            const unreadCount = notifications.filter(n => !n.isRead).length;
            if (unreadCount > 0) {
                notificationCountBadgeEl.textContent = unreadCount > 9 ? '9+' : unreadCount;
                notificationCountBadgeEl.classList.remove('hidden');
            } else {
                notificationCountBadgeEl.classList.add('hidden');
            }
            notificationBellContainerEl.classList.remove('hidden');
        }

        function renderNotificationDropdown(notifications) {
            if (!notificationListEl) return;
            if (notifications.length === 0) {
                notificationListEl.innerHTML = '<p class="text-center text-gray-500 py-4 text-sm">Nenhuma notificação.</p>';
                return;
            }

            notificationListEl.innerHTML = notifications.map(n => {
                const timeAgo = n.createdAt ? formatTimeAgo(n.createdAt.toDate()) : 'agora';
                return `
                    <div class="notification-item ${n.isRead ? 'is-read' : ''} notification-type-${n.type || 'info'}" data-id="${n.id}" data-order-id="${n.orderId || ''}" data-section="${n.sectionTarget || ''}">
                        <p class="font-medium">${n.message}</p>
                        <small>${timeAgo}</small>
                    </div>
                `;
            }).join('');
        }
        
        async function markNotificationAsRead(notificationId) {
            if (!notificationId || !notificationsCollectionRef) return;
            try {
                const notifRef = doc(notificationsCollectionRef, notificationId);
                await updateDoc(notifRef, { isRead: true });
            } catch (error) {
                console.error("Erro ao marcar notificação como lida:", error);
                showToast("Erro ao atualizar notificação.", "error");
            }
        }

        async function markAllNotificationsAsRead() {
            if (!currentAuthUser || !notificationsCollectionRef) return;
            showLoading();
            const unreadNotifications = userNotificationsCache.filter(n => !n.isRead);
            if (unreadNotifications.length === 0) {
                hideLoading();
                showToast("Todas as notificações já estão lidas.", "info");
                return;
            }
            try {
                for (const notif of unreadNotifications) {
                    const notifRef = doc(notificationsCollectionRef, notif.id);
                    await updateDoc(notifRef, { isRead: true });
                }
                showToast("Todas as notificações marcadas como lidas.", "success");
            } catch (error) {
                console.error("Erro ao marcar todas as notificações como lidas:", error);
                showToast("Erro ao atualizar notificações.", "error");
            } finally {
                hideLoading();
            }
        }
        
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "a atrás";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "m atrás";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d atrás";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h atrás";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "min atrás";
            return Math.floor(seconds) + "s atrás";
        }

        // --- End Notification System Functions ---


        function renderEstimatesControl() {
            console.log("[DEBUG] renderEstimatesControl chamada");
            if (!estimatesControlContainerEl) {
                console.error("[DEBUG] estimatesControlContainerEl não encontrado");
                return;
            }
            
            if (!currentUserProfile || currentUserProfile.role !== MANAGER_ROLE) {
                console.log("[DEBUG] Usuário não é gerente, não exibindo controle de estimativas");
                estimatesControlContainerEl.innerHTML = '<div class="card text-center"><p class="text-gray-500">Apenas gerentes podem acessar esta seção.</p></div>';
                return;
            }

            const filterValue = estimatesControlFilterInputEl ? estimatesControlFilterInputEl.value.toLowerCase().trim() : "";
            console.log("[DEBUG] Filtro aplicado:", filterValue);
            
            let estimationOrders = allOrdersCache.filter(order => order.orderPhase === 'estimation' && order.selectedStages);
            console.log("[DEBUG] Pedidos em fase de estimativa encontrados:", estimationOrders.length);
            
            if (filterValue) {
                estimationOrders = estimationOrders.filter(order => 
                    (order.id.toLowerCase().includes(filterValue)) ||
                    (order.clientName && order.clientName.toLowerCase().includes(filterValue))
                );
                console.log("[DEBUG] Pedidos após filtro:", estimationOrders.length);
            }

            if (estimationOrders.length === 0) {
                estimatesControlContainerEl.innerHTML = `<div class="card text-center">
                    <p class="text-gray-500">Nenhum pedido aguardando estimativas ${filterValue ? 'com o filtro "' + filterValue + '"' : ''}.</p>
                </div>`;
                return;
            }

            estimatesControlContainerEl.innerHTML = estimationOrders.map(order => {
                const createdDateFormatted = formatDateTime(order.createdAt); 
                const deliveryDateFormatted = formatDate(order.deliveryDate);
                
                const totalStages = order.selectedStages.length;
                const completedEstimates = order.selectedStages.filter(stageKey => 
                    order.timeline[stageKey] && typeof order.timeline[stageKey].estimatedMinutes === 'number'
                ).length;
                
                const progressPercentage = totalStages > 0 ? Math.round((completedEstimates / totalStages) * 100) : 0;
                
                const pendingStages = order.selectedStages.filter(stageKey => 
                    !order.timeline[stageKey] || order.timeline[stageKey].estimatedMinutes === null
                ).map(stageKey => {
                    const responsibleCollabs = allCollaboratorsCache.filter(collab => 
                        collab.departments && collab.departments.includes(stageKey) && collab.role !== MANAGER_ROLE
                    );
                    return {
                        stageKey,
                        stageName: getStatusText(stageKey),
                        responsibles: responsibleCollabs.map(c => c.name.split(' ')[0]).join(', ') || 'Sem responsável'
                    };
                });

                const completedStages = order.selectedStages.filter(stageKey => 
                    order.timeline[stageKey] && typeof order.timeline[stageKey].estimatedMinutes === 'number'
                ).map(stageKey => {
                    const timelineData = order.timeline[stageKey];
                    return {
                        stageKey,
                        stageName: getStatusText(stageKey),
                        estimatedTime: formatTime(timelineData.estimatedMinutes),
                        submittedAt: formatDateTime(timelineData.estimationSubmittedAt)
                    };
                });

                const itemCount = order.items ? order.items.length : 0;
                const daysSinceCreated = Math.floor((new Date() - new Date(order.createdAt)) / (1000 * 60 * 60 * 24));
                
                let urgencyClass = 'border-l-gray-400 bg-gray-100'; 
                let urgencyText = '';

                if (daysSinceCreated >= 3) {
                    urgencyText = `<span class="text-red-600 font-medium">⚠️ ${daysSinceCreated} dias aguardando</span>`;
                } else if (daysSinceCreated >= 1) {
                    urgencyText = `<span class="text-yellow-600 font-medium">⏰ ${daysSinceCreated} dia(s) aguardando</span>`;
                } else {
                    urgencyText = `<span class="text-green-600 font-medium">🆕 Criado hoje</span>`;
                }


                return `
                    <div class="card border-l-4 ${urgencyClass} mb-4">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">#${order.id.substring(0,8)} - ${order.clientName}</h3>
                                <div class="flex items-center gap-4 mt-1 text-sm text-gray-600">
                                    <span>Criado: ${createdDateFormatted}</span>
                                    <span>Entrega: ${deliveryDateFormatted}</span>
                                    <span>${itemCount} item(ns)</span>
                                    <span class="status-badge priority-${order.priority}">${(order.priority || 'normal').toUpperCase()}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="mb-2">${urgencyText}</div>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-medium">Progresso:</span>
                                    <div class="w-24 bg-gray-200 rounded-full h-2">
                                        <div class="bg-brand h-2 rounded-full transition-all duration-300" style="width: ${progressPercentage}%"></div>
                                    </div>
                                    <span class="text-sm font-medium text-brand">${completedEstimates}/${totalStages}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            ${pendingStages.length > 0 ? `
                                <div>
                                    <h4 class="font-medium text-red-700 mb-3 flex items-center gap-2">
                                        <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        Estimativas Pendentes (${pendingStages.length})
                                    </h4>
                                    <div class="space-y-2">
                                        ${pendingStages.map(stage => `
                                            <div class="flex justify-between items-center p-2 bg-red-50 rounded border border-red-200">
                                                <span class="font-medium text-red-800">${stage.stageName}</span>
                                                <span class="text-sm text-red-600">${stage.responsibles}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${completedStages.length > 0 ? `
                                <div>
                                    <h4 class="font-medium text-green-700 mb-3 flex items-center gap-2">
                                        <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        Estimativas Recebidas (${completedStages.length})
                                    </h4>
                                    <div class="space-y-2">
                                        ${completedStages.map(stage => `
                                            <div class="flex justify-between items-center p-2 bg-green-50 rounded border border-green-200">
                                                <span class="font-medium text-green-800">${stage.stageName}</span>
                                                <div class="text-right">
                                                    <span class="text-sm font-medium text-green-700">${stage.estimatedTime}</span>
                                                    <br>
                                                    <span class="text-xs text-green-600">${stage.submittedAt}</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${order.description ? `<div class="mt-4 p-3 bg-gray-50 rounded text-sm"><strong>Obs:</strong> ${order.description}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            console.log("[DEBUG] renderEstimatesControl concluída com", estimationOrders.length, "pedidos renderizados");
        }

        // 1. Funções Utilitárias
        function getStatusText(statusKey) { return STATUS_TEXT_MAP[statusKey] || statusKey; }
        function getStatusTextForPDF(statusKey) {
            const textWithEmoji = STATUS_TEXT_MAP[statusKey] || statusKey;
            if (textWithEmoji) { return textWithEmoji.replace(/[^\x00-\x7F]/g, "").trim(); }
            return textWithEmoji;
        }
        function getOrderPhaseText(phaseKey) { return ORDER_PHASE_TEXT_MAP[phaseKey] || phaseKey; }
        function getOrderPhaseTextForPDF(phaseKey) {
            const textWithEmoji = ORDER_PHASE_TEXT_MAP[phaseKey] || phaseKey;
             if (textWithEmoji) { return textWithEmoji.replace(/[^\x00-\x7F]/g, "").trim(); }
            return textWithEmoji;
        }
        function formatTime(minutes) {
            if (minutes === null || typeof minutes === 'undefined' || isNaN(minutes)) return "N/A";
            if (minutes === 0) return "0min";
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${h > 0 ? h + 'h ' : ''}${m}min`.trim();
        }
        function formatDate(dateString) {
            if (!dateString) return "N/A";
            try {
                let date;
                if (dateString.includes('T')) {
                    date = new Date(dateString);
                } else {
                    date = new Date(dateString + 'T00:00:00');
                }
                return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            } catch (e) { 
                console.warn("Erro ao formatar data (formatDate):", dateString, e);
                return dateString; 
            }
        }
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return "N/A";
            try {
                const date = new Date(dateTimeString);
                return date.toLocaleString('pt-BR', { 
                    day: '2-digit', month: '2-digit', year: 'numeric', 
                    hour: '2-digit', minute: '2-digit' 
                });
            } catch (e) { 
                console.warn("Erro ao formatar data e hora (formatDateTime):", dateTimeString, e);
                return dateTimeString; 
            }
        }
        function showLoading() { console.log("[DEBUG] showLoading"); if (loadingIndicatorEl) loadingIndicatorEl.classList.remove('hidden'); }
        function hideLoading() { console.log("[DEBUG] hideLoading"); if (loadingIndicatorEl) loadingIndicatorEl.classList.add('hidden'); }
        
        window.closeGenericModal = function() { 
            const modalEl = document.getElementById('genericModal');
            if (modalEl) modalEl.classList.add('hidden');
        }
        window.showImagePreviewModal = function(imageUrl) {
            if (previewImageSrcEl && imagePreviewModalEl) {
                previewImageSrcEl.src = imageUrl;
                previewImageSrcEl.onerror = () => {
                    previewImageSrcEl.src = 'https://placehold.co/600x400/e5e7eb/4b5563?text=Imagem+Indispon%C3%ADvel'; 
                    previewImageSrcEl.alt = 'Imagem indisponível';
                };
                imagePreviewModalEl.classList.remove('hidden');
            }
        }
        window.closeImagePreviewModal = function() {
            if (imagePreviewModalEl) {
                imagePreviewModalEl.classList.add('hidden');
                if(previewImageSrcEl) previewImageSrcEl.src = ""; 
            }
        }

        function showGenericModal(title, message, actions = [], bodyContentHTML = null) {
            const modalTitleEl = document.getElementById('genericModalTitle');
            const modalBodyEl = document.getElementById('genericModalBody');
            const actionsContainerEl = document.getElementById('genericModalActions');
            const modalEl = document.getElementById('genericModal');

            if (!modalTitleEl || !modalBodyEl || !actionsContainerEl || !modalEl) {
                alert(title + "\n" + (bodyContentHTML ? "Conteúdo dinâmico" : message) ); 
                return;
            }
            modalTitleEl.textContent = title;

            if (bodyContentHTML) {
                modalBodyEl.innerHTML = bodyContentHTML;
            } else {
                modalBodyEl.innerHTML = message ? `<p id="genericModalMessage" class="text-gray-600 mb-6">${message}</p>` : ''; 
            }
            
            actionsContainerEl.innerHTML = ''; 

            actions.forEach(action => {
                const btn = document.createElement('button');
                btn.className = `btn btn-${action.type || 'secondary'} btn-sm`;
                btn.textContent = action.text;
                btn.onclick = () => { 
                    if (action.callback) {
                        const result = action.callback();
                        // If callback returns false AND closeOnClick is explicitly false, don't close.
                        if (result === false && action.closeOnClick === false) { 
                            return; 
                        }
                    }
                    // Close modal unless closeOnClick is explicitly false.
                    if (action.closeOnClick !== false) { 
                        closeGenericModal(); 
                    }
                };
                actionsContainerEl.appendChild(btn);
            });
             if (actions.length === 0 || !actions.find(a => a.text.toLowerCase() === 'fechar' || a.text.toLowerCase() === 'cancelar')) {
                const closeBtn = document.createElement('button');
                closeBtn.className = 'btn btn-secondary btn-sm';
                closeBtn.textContent = 'Fechar';
                closeBtn.onclick = closeGenericModal;
                actionsContainerEl.appendChild(closeBtn);
            }
            modalEl.classList.remove('hidden');
        }

        // 2. Funções de Lógica de Itens de Pedido
        function createOrderItemHTML(isFirstItem = false) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'card grid grid-cols-1 md:grid-cols-4 gap-4 items-end';
            itemDiv.innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Material</label>
                    <input type="text" name="item_material" class="form-input w-full" placeholder="Ex: Vinil Fosco" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quantidade</label>
                    <input type="number" name="item_quantity" class="form-input w-full" min="1" required>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Largura (cm)</label>
                        <input type="number" name="item_width" class="form-input w-full" min="0.1" step="0.1" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Altura (cm)</label>
                        <input type="number" name="item_height" class="form-input w-full" min="0.1" step="0.1" required>
                    </div>
                </div>
                <div class="flex justify-end">
                    ${!isFirstItem ? `<button type="button" class="btn btn-danger btn-icon remove-item-btn" title="Remover item">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>` : ''}
                </div>
            `;
            if (!isFirstItem) {
                itemDiv.querySelector('.remove-item-btn').addEventListener('click', () => itemDiv.remove());
            }
            return itemDiv;
        }

        function addOrderItem(isFirst = false) {
            console.log("[DEBUG] addOrderItem chamada. isFirst:", isFirst);
            if (orderItemsContainerEl) {
                orderItemsContainerEl.appendChild(createOrderItemHTML(isFirst));
            } else {
                console.error("[DEBUG] orderItemsContainerEl não encontrado em addOrderItem");
            }
        }
        
        // 3. Funções de Renderização
        function renderAllOrdersTable() {
            console.log("[DEBUG] renderAllOrdersTable chamada. Cache de pedidos:", allOrdersCache.length);
            if (!allOrdersTableBodyEl) { console.error("[DEBUG] allOrdersTableBodyEl não encontrado em renderAllOrdersTable"); return; }
            
            const orderSelectTh = document.querySelector('.order-select-th');
            if (orderSelectTh) { 
                orderSelectTh.style.display = isOrderSelectionModeActive && currentUserProfile && currentUserProfile.role === MANAGER_ROLE ? '' : 'none';
            }


            const filterValue = orderFilterInputEl ? orderFilterInputEl.value.toLowerCase().trim() : "";
            let ordersToRender = allOrdersCache;

            if (filterValue) {
                ordersToRender = allOrdersCache.filter(order => 
                    (order.id.substring(0, 5).toLowerCase().includes(filterValue)) ||
                    (order.clientName && order.clientName.toLowerCase().includes(filterValue))
                );
            }

            if (ordersToRender.length === 0) {
                const colspan = isOrderSelectionModeActive && currentUserProfile && currentUserProfile.role === MANAGER_ROLE ? 12 : 11;
                allOrdersTableBodyEl.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-8 text-gray-500">Nenhum pedido encontrado ${filterValue ? 'com o filtro "' + filterValue + '"' : ''}.</td></tr>`;
                return;
            }
            
            allOrdersTableBodyEl.innerHTML = ordersToRender.map(order => {
                const deliveryDateFormatted = formatDate(order.deliveryDate);
                const createdDateTimeFormatted = formatDateTime(order.createdAt); 
                const productionStartDateFormatted = order.productionStartDate ? formatDate(order.productionStartDate) : 'N/A'; 
                
                let statusDisplay = getStatusText(order.status);
                if (order.orderPhase === 'estimation') {
                    statusDisplay = getStatusText('estimation'); 
                } else {
                    const stageKey = order.status;
                    const collab = allCollaboratorsCache.find(c => c.departments && c.departments.includes(stageKey));
                    if (collab) statusDisplay += ` (${collab.name.split(' ')[0]})`;
                    else { 
                        if(stageKey === MANAGER_REVIEW_STAGE_KEY){
                             const manager = allCollaboratorsCache.find(c => c.role === MANAGER_ROLE);
                             if(manager) statusDisplay += ` (${manager.name.split(' ')[0]})`;
                        }
                    }
                }
                
                let calculatedTotalEstimatedTime = 0;
                if (order.timeline && order.selectedStages) { 
                    order.selectedStages.forEach(stageKey => {
                        if (order.timeline[stageKey] && typeof order.timeline[stageKey].estimatedMinutes === 'number') {
                            calculatedTotalEstimatedTime += order.timeline[stageKey].estimatedMinutes;
                        }
                    });
                }
                const itemCount = order.items ? order.items.length : 0;
                const firstItemDesc = order.items && order.items[0] ? `${order.items[0].quantity}x ${order.items[0].material}` : 'N/A';

                let actionsHTML = ''; 

                actionsHTML += `<button class="btn btn-secondary btn-icon view-report-btn" data-order-id="${order.id}" title="Ver Relatório Completo">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                </button>`;

                if (currentUserProfile && currentUserProfile.role === MANAGER_ROLE) {
                    actionsHTML += `<button class="btn btn-secondary btn-icon edit-dates-btn ml-2" data-order-id="${order.id}" title="Editar Datas">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </button>`;
                    actionsHTML += `<button class="btn btn-secondary btn-icon pdf-btn ml-2" data-order-id="${order.id}" title="Gerar PDF">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </button>`;
                }


                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="text-center order-select-td ${isOrderSelectionModeActive && currentUserProfile && currentUserProfile.role === MANAGER_ROLE ? '' : 'hidden'}">
                            <input type="checkbox" class="form-checkbox order-select-checkbox" data-order-id="${order.id}" ${selectedOrdersForDeletion.has(order.id) ? 'checked' : ''}>
                        </td>
                        <td class="text-xs font-mono text-gray-500">${order.id.substring(0, 5)}...</td>
                        <td class="font-medium">${order.clientName || 'N/A'}</td>
                        <td>${itemCount > 1 ? itemCount + ' itens' : firstItemDesc}</td>
                        <td><span class="status-badge phase-${order.orderPhase || 'estimation'}">${getOrderPhaseText(order.orderPhase)}</span></td>
                        <td><span class="status-badge status-${order.status}">${statusDisplay}</span></td>
                        <td class="text-sm text-gray-600">${createdDateTimeFormatted}</td> <td class="text-sm">${productionStartDateFormatted}</td> 
                        <td class="text-sm">${deliveryDateFormatted}</td>
                        <td><span class="status-badge priority-${order.priority}">${(order.priority || 'normal').toUpperCase()}</span></td>
                        <td class="font-medium">${formatTime(calculatedTotalEstimatedTime)}</td>
                        <td><div class="flex items-center gap-1">${actionsHTML}</div></td>
                    </tr>`;
            }).join('');

            allOrdersTableBodyEl.querySelectorAll('.pdf-btn').forEach(btn => {
                btn.addEventListener('click', () => generateOrderPDF(btn.dataset.orderId));
            });
            allOrdersTableBodyEl.querySelectorAll('.view-report-btn').forEach(btn => {
                btn.addEventListener('click', () => openOrderDetailsReportModal(btn.dataset.orderId));
            });
             allOrdersTableBodyEl.querySelectorAll('.edit-dates-btn').forEach(btn => {
                btn.addEventListener('click', () => openEditOrderDatesModal(btn.dataset.orderId));
            });
            
            allOrdersTableBodyEl.querySelectorAll('.order-select-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const orderId = e.target.dataset.orderId;
                    if (e.target.checked) {
                        selectedOrdersForDeletion.add(orderId);
                    } else {
                        selectedOrdersForDeletion.delete(orderId);
                    }
                    if(deleteSelectedOrdersBtnEl) deleteSelectedOrdersBtnEl.disabled = selectedOrdersForDeletion.size === 0;
                    if(deleteSelectedOrdersBtnEl) deleteSelectedOrdersBtnEl.textContent = selectedOrdersForDeletion.size > 0 ? `Excluir ${selectedOrdersForDeletion.size} Selecionado(s)` : 'Excluir Selecionados';
                });
            });
        }

        function renderOrderCard(order) {
             if(!currentUserProfile) return ''; 
            const deliveryDateFormatted = formatDate(order.deliveryDate);
            const createdDateTimeFormatted = formatDateTime(order.createdAt); 
            const productionStartDateFormatted = order.productionStartDate ? formatDate(order.productionStartDate) : 'N/A';
            let taskSpecificHTML = '';
            let actionButtonHTML = '';
            let imageButtonHTML = ''; 
            const userDepartments = currentUserProfile.departments || [];
            const userRole = currentUserProfile.role;
            
            let relevantStageForUserInCard = order.status; 
            if (order.orderPhase === 'estimation' && order.selectedStages) {
                relevantStageForUserInCard = order.selectedStages.find(s => 
                    userDepartments.includes(s) && 
                    (!order.timeline[s] || order.timeline[s].estimatedMinutes === null)
                ) || 'estimation'; 
            }

            const itemCount = order.items ? order.items.length : 0;
            const itemsSummary = order.items && order.items.length > 0 ? 
                order.items.map(item => `${item.quantity}x ${item.material} (${item.width}x${item.height}cm)`).slice(0,2).join('; ') + (order.items.length > 2 ? '...' : '')
                : 'Nenhum item especificado';

            if (order.coverImageUrl) {
                imageButtonHTML = `<button data-image-url="${order.coverImageUrl}" class="btn btn-secondary btn-icon view-image-btn" title="Ver Imagem">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                </button>`;
            }

            if (order.orderPhase === 'estimation' && userRole !== MANAGER_ROLE && order.selectedStages && userDepartments.some(dept => order.selectedStages.includes(dept))) {
                const stageToEstimateForUser = order.selectedStages.find(s => userDepartments.includes(s) && (!order.timeline[s] || order.timeline[s].estimatedMinutes === null));
                if (stageToEstimateForUser) {
                    taskSpecificHTML = `
                        <div class="mt-4 p-3 bg-orange-50 rounded-lg border border-orange-200">
                            <label for="estTime-${order.id}-${stageToEstimateForUser}" class="block text-sm font-medium text-gray-700 mb-2">
                                Estimativa para ${getStatusText(stageToEstimateForUser)} (minutos):
                            </label>
                            <input type="number" id="estTime-${order.id}-${stageToEstimateForUser}" 
                                   class="form-input w-32" min="0" placeholder="Ex: 30">
                        </div>`;
                    actionButtonHTML = `<button data-order-id="${order.id}" data-stage-key="${stageToEstimateForUser}" class="btn btn-primary btn-sm estimate-btn">
                        Enviar Estimativa
                    </button>`;
                }
            } else if (order.orderPhase === 'manager_review' && userRole === MANAGER_ROLE) {
                 const estimatedTimesSummary = order.selectedStages.map(sKey => 
                    `${getStatusTextForPDF(sKey)}: ${formatTime(order.timeline[sKey]?.estimatedMinutes)}`
                ).join('; ');
                taskSpecificHTML = `
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <p class="text-sm text-blue-800 font-medium">Aguardando aprovação</p>
                        <p class="text-xs text-blue-600 mt-1">Estimativas: ${estimatedTimesSummary || 'Nenhuma'}</p>
                    </div>`;
                actionButtonHTML = `<button data-order-id="${order.id}" class="btn btn-primary btn-sm prompt-prod-date-btn">
                    <svg class="icon-sm mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293H15M9 10V9a2 2 0 012-2h2a2 2 0 012 2v1M9 10v5a2 2 0 002 2h2a2 2 0 002-2v-5"/>
                    </svg>
                    Definir Data e Iniciar Produção
                </button>`;
            } else if (order.orderPhase === 'production' && userDepartments.includes(order.status)) {
                const prodStageData = order.timeline[order.status] || {};
                taskSpecificHTML = `
                    <div class="mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
                        <p class="text-sm text-green-800">Tempo Estimado: <span class="font-medium">${formatTime(prodStageData.estimatedMinutes)}</span></p>
                        ${prodStageData.actualMinutes ? `<p class="text-sm text-green-600 mt-1">Tempo Real: <span class="font-medium">${formatTime(prodStageData.actualMinutes)}</span></p>` : ''}
                        ${order.productionStartDate ? `<p class="text-sm text-gray-600 mt-1">Início Produção (Pedido): <span class="font-medium">${productionStartDateFormatted}</span></p>` : ''}
                        ${prodStageData.productionStartTime ? `<p class="text-sm text-gray-600 mt-1">Início Etapa: <span class="font-medium">${formatDateTime(prodStageData.productionStartTime)}</span></p>` : ''}
                    </div>`;
                actionButtonHTML = `<button data-order-id="${order.id}" class="btn btn-primary btn-sm advance-prod-btn">
                    <svg class="icon-sm mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Concluir Etapa
                </button>`;
            }

            if (order.orderPhase === 'completed') {
                 actionButtonHTML = `<span class="inline-flex items-center gap-2 text-green-600 font-medium">
                    <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Concluído
                 </span>`;
            }
            
             if (userRole === MANAGER_ROLE && order.orderPhase !== 'manager_review' && order.orderPhase !== 'completed' && !isOrderSelectionModeActive) { 
                 actionButtonHTML += `
                    <button data-order-id="${order.id}" class="btn btn-danger btn-sm delete-btn ml-2">
                        <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>`;
            }
            
            let currentStatusForCardDisplay = order.status;
             if (order.orderPhase === 'estimation') {
                currentStatusForCardDisplay = 'estimation'; 
            }

            return `
                <div class="card card-queue ${order.orderPhase ? 'phase-' + order.orderPhase : ''}">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-semibold text-gray-900">#${order.id.substring(0,5)} - ${order.clientName}</h3>
                            <span class="status-badge phase-${order.orderPhase || 'estimation'}">${getOrderPhaseText(order.orderPhase)}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            ${imageButtonHTML}
                            <span class="status-badge priority-${order.priority}">${(order.priority || 'normal').toUpperCase()}</span>
                        </div>
                    </div>
                    <div class="space-y-2 text-sm text-gray-600">
                        <p><span class="font-medium">Itens:</span> ${itemCount} (${itemsSummary})</p>
                        <p><span class="font-medium">Criado em:</span> ${createdDateTimeFormatted}</p> <p><span class="font-medium">Início Produção (Pedido):</span> ${productionStartDateFormatted}</p>
                        <p><span class="font-medium">Entrega:</span> ${deliveryDateFormatted}</p>
                        <p><span class="font-medium">Status:</span> <span class="status-badge status-${currentStatusForCardDisplay}">${getStatusText(currentStatusForCardDisplay)}</span></p>
                        <p><span class="font-medium">Etapas:</span> ${order.selectedStages ? order.selectedStages.map(s => getStatusText(s)).join(', ') : 'N/A'}</p>
                    </div>
                    ${order.description ? `<div class="mt-3 p-3 bg-gray-50 rounded text-sm text-gray-700"><strong>Obs:</strong> ${order.description}</div>` : ''}
                    ${taskSpecificHTML}
                    <div class="mt-4 flex justify-end">
                        ${actionButtonHTML}
                    </div>
                </div>`;
        }

        function renderMyQueue() {
            console.log("[DEBUG] renderMyQueue chamada. UserProfile:", currentUserProfile);
            if (!myQueueTitleEl || !myQueueEstimationListEl || !myQueueProductionListEl || !currentUserProfile) {
                console.warn("[DEBUG] renderMyQueue: Elementos da UI ou perfil do usuário não encontrados. Saindo...");
                if(myQueueEstimationListEl) myQueueEstimationListEl.innerHTML = '<p class="text-gray-500">Faça login para ver sua fila.</p>';
                if(myQueueProductionListEl) myQueueProductionListEl.innerHTML = '';
                if(myQueueTitleEl) myQueueTitleEl.textContent = 'Minha Fila de Trabalho';
                return;
            }
            myQueueTitleEl.textContent = `Minha Fila de Trabalho (${currentUserProfile.name || currentUserProfile.email})`;

            const myQueueFilterValue = myQueueFilterInputEl ? myQueueFilterInputEl.value.toLowerCase().trim() : "";
            const userDepartments = currentUserProfile.departments || [];
            console.log("[DEBUG] renderMyQueue - User Departments:", userDepartments);

            let tasksForEstimationColumn = [];
            if (currentUserProfile.role !== MANAGER_ROLE) {
                tasksForEstimationColumn = allOrdersCache.filter(order => {
                    const isEstimationPhase = order.orderPhase === 'estimation';
                    const hasSelectedStages = order.selectedStages && order.selectedStages.length > 0;
                    if (!isEstimationPhase || !hasSelectedStages) return false;

                    return userDepartments.some(dept => 
                        order.selectedStages.includes(dept) &&
                        (!order.timeline[dept] || order.timeline[dept].estimatedMinutes === null)
                    );
                });
            }
            console.log("[DEBUG] renderMyQueue - Tarefas para Estimativa (antes do filtro de texto):", tasksForEstimationColumn.length);

            let tasksForProductionColumn = [];
            if (currentUserProfile.role === MANAGER_ROLE) {
                tasksForProductionColumn = allOrdersCache.filter(order => order.orderPhase === 'manager_review');
            } else { 
                tasksForProductionColumn = allOrdersCache.filter(order =>
                    order.orderPhase === 'production' &&
                    userDepartments.includes(order.status)
                );
            }
             console.log("[DEBUG] renderMyQueue - Tarefas para Produção/Revisão (antes do filtro de texto):", tasksForProductionColumn.length);
            
            if (myQueueFilterValue) {
                tasksForEstimationColumn = tasksForEstimationColumn.filter(order => 
                    (order.id.substring(0,5).toLowerCase().includes(myQueueFilterValue)) ||
                    (order.clientName && order.clientName.toLowerCase().includes(myQueueFilterValue))
                );
                tasksForProductionColumn = tasksForProductionColumn.filter(order => 
                     (order.id.substring(0,5).toLowerCase().includes(myQueueFilterValue)) ||
                    (order.clientName && order.clientName.toLowerCase().includes(myQueueFilterValue))
                );
            }
            
            myQueueEstimationListEl.innerHTML = tasksForEstimationColumn.length > 0 ? tasksForEstimationColumn.map(order => renderOrderCard(order)).join('') : `<p class="text-gray-500">Nenhum pedido aguardando sua estimativa ${myQueueFilterValue ? 'com o filtro "' + myQueueFilterValue + '"' : ''}.</p>`;
            myQueueProductionListEl.innerHTML = tasksForProductionColumn.length > 0 ? tasksForProductionColumn.map(order => renderOrderCard(order)).join('') : `<p class="text-gray-500">Nenhum pedido em produção ou para sua revisão ${myQueueFilterValue ? 'com o filtro "' + myQueueFilterValue + '"' : ''}.</p>`;
            
            document.querySelectorAll('.estimate-btn').forEach(btn => btn.addEventListener('click', () => handleEstimateSubmission(btn.dataset.orderId, btn.dataset.stageKey)));
            document.querySelectorAll('.prompt-prod-date-btn').forEach(btn => btn.addEventListener('click', () => promptForProductionStartDate(btn.dataset.orderId)));
            document.querySelectorAll('.advance-prod-btn').forEach(btn => btn.addEventListener('click', () => handleAdvanceProduction(btn.dataset.orderId)));
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', () => confirmDeleteOrder(btn.dataset.orderId)));
            document.querySelectorAll('.view-image-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); showImagePreviewModal(btn.dataset.imageUrl); }));
        }

        function renderTimeDashboard() {
            console.log("[DEBUG] renderTimeDashboard chamada");
            if (!timeDashboardContainerEl || !dashboardTitleEl) {console.warn("[DEBUG] Elementos do dashboard não encontrados."); return;}
            const filterValue = dashboardFilterInputEl ? dashboardFilterInputEl.value.toLowerCase().trim() : "";

            if (filterValue) {
                dashboardTitleEl.textContent = `Detalhes do Pedido (Filtro: ${filterValue})`;
                const filteredOrders = allOrdersCache.filter(order => 
                    (order.id.toLowerCase().includes(filterValue)) ||
                    (order.clientName && order.clientName.toLowerCase().includes(filterValue))
                );

                if (filteredOrders.length === 0) {
                    timeDashboardContainerEl.innerHTML = `<div class="card text-center col-span-full"><p class="text-gray-500">Nenhum pedido encontrado com o filtro "${filterValue}".</p></div>`;
                    return;
                }
                
                const order = filteredOrders[0]; 
                dashboardTitleEl.textContent = filteredOrders.length > 1 ? 
                    `Detalhes do Pedido (Filtro: ${filterValue}) - Mostrando o primeiro de ${filteredOrders.length}` :
                    `Detalhes do Pedido: #${order.id.substring(0,5)} - ${order.clientName}`;

                if (!order.timeline || !order.selectedStages) {
                    timeDashboardContainerEl.innerHTML = `<div class="card text-center col-span-full"><p class="text-gray-500">Este pedido não possui dados de tempo detalhados.</p></div>`;
                    return;
                }

                timeDashboardContainerEl.innerHTML = order.selectedStages.map(stageKey => {
                    const stageData = order.timeline[stageKey] || {};
                    const estimated = stageData.estimatedMinutes;
                    const actual = stageData.actualMinutes;
                    const difference = (typeof actual === 'number' && typeof estimated === 'number') ? actual - estimated : null;
                    let diffColorClass = 'text-gray-400';
                    let percentageDiffText = 'N/A';

                    if (typeof actual === 'number') { 
                        if (typeof estimated === 'number' && estimated > 0) {
                            if (difference > 0) diffColorClass = 'text-red-500';
                            else if (difference < 0) diffColorClass = 'text-green-500';
                            percentageDiffText = ((difference / estimated) * 100).toFixed(1) + '%';
                        } else if (typeof estimated !== 'number' && actual > 0) {
                             diffColorClass = 'text-yellow-500'; 
                             percentageDiffText = 'Sem Est.';
                        }
                    } else if (typeof estimated === 'number') { 
                        percentageDiffText = 'Pendente';
                    }

                    return `
                        <div class="card">
                            <h3 class="text-lg font-semibold text-brand mb-3">${getStatusTextForPDF(stageKey)}</h3>
                            <div class="space-y-2">
                                <p class="text-sm"><span class="text-gray-600">Estimado:</span> <span class="font-medium">${formatTime(estimated)}</span></p>
                                <p class="text-sm"><span class="text-gray-600">Real:</span> <span class="font-medium">${formatTime(actual)}</span></p>
                                ${typeof actual === 'number' || typeof estimated === 'number' ? `<p class="text-sm ${diffColorClass}"><span class="text-gray-600">Diferença:</span> ${formatTime(difference)} (${difference > 0 && typeof difference === 'number' ? '+' : ''}${percentageDiffText})</p>` : ''}
                            </div>
                        </div>`;
                }).join('');
                 if (order.selectedStages.length === 0) {
                    timeDashboardContainerEl.innerHTML = `<div class="card text-center col-span-full"><p class="text-gray-500">Nenhuma etapa selecionada para este pedido.</p></div>`;
                }

            } else {
                dashboardTitleEl.textContent = "Dashboard de Tempos por Etapa (Geral)";
                const timeDataByStage = ALL_POSSIBLE_STAGES.reduce((acc, stage) => { 
                    acc[stage.key] = { stageName: stage.name, totalEstimated: 0, totalActual: 0, count: 0 };
                    return acc;
                }, {});

                allOrdersCache.forEach(order => {
                    if (order.timeline && order.selectedStages) { 
                        order.selectedStages.forEach(stageKey => {
                            if (order.timeline[stageKey] && timeDataByStage[stageKey]) {
                                const stageDetail = order.timeline[stageKey];
                                if (typeof stageDetail.estimatedMinutes === 'number') timeDataByStage[stageKey].totalEstimated += stageDetail.estimatedMinutes;
                                if (typeof stageDetail.actualMinutes === 'number') {
                                    timeDataByStage[stageKey].totalActual += stageDetail.actualMinutes;
                                    timeDataByStage[stageKey].count++;
                                }
                            }
                        });
                    }
                });

                timeDashboardContainerEl.innerHTML = Object.values(timeDataByStage).map(data => {
                    const difference = data.totalActual - data.totalEstimated;
                    let diffColorClass = 'text-gray-500'; 
                    let percentageDiffText = '0%';
                    if (data.count > 0 && data.totalEstimated > 0) { 
                        if (difference > 0) diffColorClass = 'text-red-500'; 
                        else if (difference < 0) diffColorClass = 'text-green-500'; 
                        percentageDiffText = ((difference / data.totalEstimated) * 100).toFixed(1) + '%';
                    } else if (data.count > 0 && data.totalEstimated === 0 && data.totalActual > 0) {
                        diffColorClass = 'text-red-500'; percentageDiffText = 'N/A Est.';
                    } else if (data.count === 0 && data.totalEstimated > 0) {
                         percentageDiffText = 'Pendente Real';
                    }
                    return `
                        <div class="card">
                            <h3 class="text-xl font-semibold text-brand mb-4">${data.stageName}</h3>
                            <div class="space-y-3">
                                <p><span class="text-gray-600">Total Estimado:</span> <span class="font-semibold text-lg">${formatTime(data.totalEstimated)}</span></p>
                                <p><span class="text-gray-600">Total Real:</span> <span class="font-semibold text-lg">${formatTime(data.totalActual)}</span></p>
                                <p class="${diffColorClass}"><span class="text-gray-600">Diferença:</span> <span class="font-semibold">${formatTime(difference)} (${difference > 0 ? '+' : ''}${percentageDiffText})</span></p>
                            </div>
                        </div>`;
                }).join('');
                if (Object.keys(timeDataByStage).length === 0 || allOrdersCache.length === 0) {
                     timeDashboardContainerEl.innerHTML = '<div class="card text-center col-span-full"><p class="text-gray-500">Nenhum dado de tempo para exibir.</p></div>';
                }
            }
        }
        
        function renderDailyProductionLoadReport() {
            console.log("[DEBUG] renderDailyProductionLoadReport chamada");
            if (!dailyLoadReportContainerEl || !calendarViewContainerEl) return;

            const activeOrders = allOrdersCache.filter(order => order.orderPhase !== 'completed');
            dailyLoadCache = {}; 

            activeOrders.forEach(order => {
                if (order.deliveryDate && order.timeline && order.selectedStages) {
                    let orderTotalEstimatedTime = 0;
                    order.selectedStages.forEach(stageKey => {
                        const stageTimeline = order.timeline[stageKey];
                        if (stageTimeline && typeof stageTimeline.estimatedMinutes === 'number') {
                            if (order.orderPhase === 'estimation' || order.orderPhase === 'manager_review') {
                                orderTotalEstimatedTime += stageTimeline.estimatedMinutes;
                            } else if (order.orderPhase === 'production') {
                                const currentStageIndexInSelected = order.selectedStages.indexOf(order.status);
                                const thisStageIndexInSelected = order.selectedStages.indexOf(stageKey);
                                if (thisStageIndexInSelected >= currentStageIndexInSelected && typeof stageTimeline.actualMinutes !== 'number') {
                                     orderTotalEstimatedTime += stageTimeline.estimatedMinutes;
                                }
                            }
                        }
                    });

                    if (orderTotalEstimatedTime > 0) {
                        const dateKey = currentReportCalendarType === 'production' ? order.productionStartDate : order.deliveryDate;
                        if (dateKey) { 
                            if (!dailyLoadCache[dateKey]) {
                                dailyLoadCache[dateKey] = { totalTime: 0, orderCount: 0, orders: [] };
                            }
                            dailyLoadCache[dateKey].totalTime += orderTotalEstimatedTime;
                            dailyLoadCache[dateKey].orderCount++;
                            dailyLoadCache[dateKey].orders.push({ 
                                id: order.id,
                                clientName: order.clientName || "N/A",
                                estimatedTime: orderTotalEstimatedTime,
                                productionStartDate: order.productionStartDate || null,
                                deliveryDate: order.deliveryDate || null
                            });
                        }
                    }
                }
            });

            const sortedDeliveryDates = Object.keys(dailyLoadCache).filter(dateKey => {
                return allOrdersCache.some(order => order.deliveryDate === dateKey && order.orderPhase !== 'completed');
            }).sort((a,b) => new Date(a) - new Date(b));


            if (dailyLoadReportListContainerEl.style.display !== 'none') { 
                let listCache = {};
                activeOrders.forEach(order => { 
                     if (order.deliveryDate && order.timeline && order.selectedStages) {
                        let orderTotalEstimatedTime = 0;
                        order.selectedStages.forEach(stageKey => { 
                            const stageTimeline = order.timeline[stageKey];
                            if (stageTimeline && typeof stageTimeline.estimatedMinutes === 'number') {
                                if (order.orderPhase === 'estimation' || order.orderPhase === 'manager_review') {
                                    orderTotalEstimatedTime += stageTimeline.estimatedMinutes;
                                } else if (order.orderPhase === 'production') {
                                    const currentStageIndexInSelected = order.selectedStages.indexOf(order.status);
                                    const thisStageIndexInSelected = order.selectedStages.indexOf(stageKey);
                                    if (thisStageIndexInSelected >= currentStageIndexInSelected && typeof stageTimeline.actualMinutes !== 'number') {
                                        orderTotalEstimatedTime += stageTimeline.estimatedMinutes;
                                    }
                                }
                            }
                        });
                        if(orderTotalEstimatedTime > 0) {
                            if (!listCache[order.deliveryDate]) {
                                listCache[order.deliveryDate] = { totalTime: 0, orderCount: 0, orders: [] };
                            }
                            listCache[order.deliveryDate].totalTime += orderTotalEstimatedTime;
                            listCache[order.deliveryDate].orderCount++;
                            listCache[order.deliveryDate].orders.push({ 
                                id: order.id, clientName: order.clientName || "N/A", estimatedTime: orderTotalEstimatedTime,
                                productionStartDate: order.productionStartDate || null, deliveryDate: order.deliveryDate || null
                            });
                        }
                    }
                });
                const sortedListDates = Object.keys(listCache).sort((a,b) => new Date(a) - new Date(b));


                if (dailyLoadReportContainerEl) {
                    if (sortedListDates.length === 0) {
                        dailyLoadReportContainerEl.innerHTML = '<div class="card text-center"><p class="text-gray-500">Nenhuma carga de produção futura encontrada.</p></div>';
                    } else {
                        dailyLoadReportContainerEl.innerHTML = sortedListDates.map(date => {
                            const data = listCache[date];
                            const displayDate = new Date(date + 'T00:00:00').toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: 'short' });
                            return `
                                <div class="card daily-load-card cursor-pointer hover:shadow-lg hover:border-brand-orange transition-all" data-date="${date}" data-view-type="delivery">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="font-semibold text-brand text-lg">${displayDate}</p>
                                            <p class="text-sm text-gray-600">${data.orderCount} pedido(s)</p>
                                        </div>
                                        <p class="text-2xl font-bold text-gray-900">${formatTime(data.totalTime)}</p>
                                    </div>
                                </div>
                            `;
                        }).join('');

                        dailyLoadReportContainerEl.querySelectorAll('.daily-load-card').forEach(card => {
                            card.addEventListener('click', () => {
                                const dateKey = card.dataset.date;
                                const viewType = card.dataset.viewType; 
                                if (listCache[dateKey] && listCache[dateKey].orders) {
                                    showDailyLoadDetailsModal(dateKey, listCache[dateKey].orders, viewType);
                                } else {
                                    console.warn(`[DEBUG] Nenhum pedido encontrado no cache para a data: ${dateKey}`);
                                    showGenericModal("Detalhes da Carga", `Nenhum pedido detalhado encontrado para ${formatDate(dateKey)}.`);
                                }
                            });
                        });
                    }
                }
            }
            renderCalendarView(); 
        }

        function renderCalendarView() {
            if (!calendarViewContainerEl || !calendarMonthYearEl || !calendarDaysGridEl || !calendarDaysNamesEl) {
                console.error("[DEBUG] Elementos do calendário não encontrados.");
                return;
            }

            calendarMonthYearEl.textContent = currentCalendarDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            calendarDaysGridEl.innerHTML = ''; 

            if (calendarDaysNamesEl.children.length === 0) { 
                const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                dayNames.forEach(name => {
                    const dayNameDiv = document.createElement('div');
                    dayNameDiv.className = 'calendar-day-name';
                    dayNameDiv.textContent = name;
                    calendarDaysNamesEl.appendChild(dayNameDiv);
                });
            }
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const startDayOfWeek = firstDayOfMonth.getDay(); 

            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyDayDiv = document.createElement('div');
                emptyDayDiv.className = 'calendar-day other-month';
                calendarDaysGridEl.appendChild(emptyDayDiv);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                
                const dayNumberSpan = document.createElement('span');
                dayNumberSpan.className = 'day-number';
                dayNumberSpan.textContent = day;
                dayDiv.appendChild(dayNumberSpan);

                const currentDateObj = new Date(year, month, day);
                const dateString = currentDateObj.toISOString().split('T')[0]; 

                if (dateString === new Date().toISOString().split('T')[0]) {
                    dayDiv.classList.add('today');
                }
                
                let dayLoadData;
                let ordersForThisDay = [];

                if (currentReportCalendarType === 'production') {
                    ordersForThisDay = allOrdersCache.filter(order => order.productionStartDate === dateString && order.orderPhase !== 'completed');
                } else { // 'delivery'
                    ordersForThisDay = allOrdersCache.filter(order => order.deliveryDate === dateString && order.orderPhase !== 'completed');
                }
                
                if (ordersForThisDay.length > 0) {
                    dayLoadData = {
                        totalTime: ordersForThisDay.reduce((sum, order) => {
                            let orderTime = 0;
                            if (order.timeline && order.selectedStages) {
                                order.selectedStages.forEach(stageKey => {
                                    const stageTimeline = order.timeline[stageKey];
                                    if (stageTimeline && typeof stageTimeline.estimatedMinutes === 'number') {
                                         if (order.orderPhase === 'estimation' || order.orderPhase === 'manager_review') {
                                            orderTime += stageTimeline.estimatedMinutes;
                                        } else if (order.orderPhase === 'production') {
                                            const currentStageIndexInSelected = order.selectedStages.indexOf(order.status);
                                            const thisStageIndexInSelected = order.selectedStages.indexOf(stageKey);
                                            if (thisStageIndexInSelected >= currentStageIndexInSelected && typeof stageTimeline.actualMinutes !== 'number') {
                                                orderTime += stageTimeline.estimatedMinutes;
                                            }
                                        }
                                    }
                                });
                            }
                            return sum + orderTime;
                        }, 0),
                        orderCount: ordersForThisDay.length,
                        orders: ordersForThisDay.map(o => ({ 
                            id: o.id, 
                            clientName: o.clientName || "N/A", 
                            estimatedTime: o.timeline && o.selectedStages ? o.selectedStages.reduce((sum, sk) => sum + (o.timeline[sk]?.estimatedMinutes || 0), 0) : 0,
                            productionStartDate: o.productionStartDate || null,
                            deliveryDate: o.deliveryDate || null
                        }))
                    };
                }


                if (dayLoadData && dayLoadData.orderCount > 0) {
                    dayDiv.classList.add('has-load');
                    const loadInfoSpan = document.createElement('span');
                    loadInfoSpan.className = 'load-info';
                    loadInfoSpan.textContent = `${formatTime(dayLoadData.totalTime)}`;
                    dayDiv.appendChild(loadInfoSpan);

                    dayDiv.addEventListener('click', () => {
                        showDailyLoadDetailsModal(dateString, dayLoadData.orders, currentReportCalendarType);
                    });
                }
                calendarDaysGridEl.appendChild(dayDiv);
            }

            const totalCells = startDayOfWeek + daysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let i = 0; i < remainingCells; i++) {
                 const emptyDayDiv = document.createElement('div');
                emptyDayDiv.className = 'calendar-day other-month';
                calendarDaysGridEl.appendChild(emptyDayDiv);
            }
        }


        function renderCollaboratorsList() {
            console.log("[DEBUG] renderCollaboratorsList chamada");
            if (!collaboratorsListEl) {
                console.error("[DEBUG] collaboratorsListEl não encontrado");
                return;
            }

            if (!currentUserProfile || currentUserProfile.role !== MANAGER_ROLE) {
                collaboratorsListEl.innerHTML = '<p class="text-gray-500 text-sm italic">Apenas gerentes podem ver esta lista.</p>';
                return;
            }

            if (allCollaboratorsCache.length === 0) {
                collaboratorsListEl.innerHTML = '<p class="text-gray-500">Nenhum colaborador cadastrado.</p>';
                return;
            }

            collaboratorsListEl.innerHTML = allCollaboratorsCache.map(collab => {
                const departmentsText = collab.departments && collab.departments.length > 0 
                    ? collab.departments.map(dept => {
                        const stage = ALL_POSSIBLE_STAGES.find(s => s.key === dept);
                        return stage ? stage.name : dept;
                      }).join(', ') 
                    : 'Nenhum departamento';

                const roleText = collab.role === MANAGER_ROLE ? 'Gerente' : 'Colaborador';

                return `
                    <div class="card">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-900">${collab.name || 'Nome não informado'}</h4>
                                <p class="text-sm text-gray-600">${collab.email}</p>
                                <div class="mt-2 space-y-1">
                                    <p class="text-xs"><span class="font-medium">Função:</span> ${roleText}</p>
                                    <p class="text-xs"><span class="font-medium">Departamentos:</span> ${departmentsText}</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="openEditCollaboratorModal('${collab.id}')" class="btn btn-secondary btn-icon" title="Editar">
                                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                <button onclick="deleteCollaborator('${collab.id}')" class="btn btn-danger btn-icon" title="Excluir">
                                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 4. Funções de Manipulação de Dados e Ações
        function loadOrdersFromFirestore() {
            if (!ordersCollectionRef) { 
                console.warn("[DEBUG] loadOrdersFromFirestore: ordersCollectionRef não está definida. Isso é esperado se o usuário não estiver logado ou se o perfil não foi carregado.");
                hideLoading(); 
                return; 
            }
            console.log("[DEBUG] Tentando carregar pedidos do Firestore...");
            showLoading();
            if (unsubscribeOrders) unsubscribeOrders(); 

            unsubscribeOrders = onSnapshot(query(ordersCollectionRef), (querySnapshot) => { 
                console.log("[DEBUG] Recebido snapshot de pedidos, contagem:", querySnapshot.size);
                allOrdersCache = [];
                querySnapshot.forEach((doc) => {
                    allOrdersCache.push({ id: doc.id, ...doc.data() });
                });
                allOrdersCache.sort((a, b) => {
                    const priorityOrder = { urgente: 0, alta: 1, normal: 2 };
                    const priorityA = priorityOrder[a.priority] ?? 2;
                    const priorityB = priorityOrder[b.priority] ?? 2;
                    if (priorityA < priorityB) return -1;
                    if (priorityA > priorityB) return 1;
                    
                    const dateA = a.productionStartDate || a.deliveryDate;
                    const dateB = b.productionStartDate || b.deliveryDate;
                    return new Date(dateA) - new Date(dateB);
                });
                
                console.log("[DEBUG] Renderizando todas as tabelas e dashboards após carregar pedidos.");
                renderAllOrdersTable();
                renderMyQueue();
                if (currentUserProfile && currentUserProfile.role === MANAGER_ROLE) {
                    renderTimeDashboard(); 
                }
                renderDailyProductionLoadReport(); 
                if (currentUserProfile && currentUserProfile.role === MANAGER_ROLE) {
                    renderEstimatesControl();
                }
                hideLoading();
            }, (error) => {
                console.error("[DEBUG] Erro ao carregar pedidos do Firestore: ", error);
                showGenericModal("Erro de Carregamento", "Não foi possível buscar os pedidos do banco de dados.");
                hideLoading();
            });
        }
        
        function loadCollaborators() {
            console.log("[DEBUG] loadCollaborators chamada");
            console.log("[DEBUG] collaboratorsCollectionRef:", collaboratorsCollectionRef);
            console.log("[DEBUG] currentUserProfile:", currentUserProfile);
            
            if (!collaboratorsCollectionRef) {
                console.error("[DEBUG] collaboratorsCollectionRef não definida");
                if(collaboratorsListEl) collaboratorsListEl.innerHTML = '<p class="text-red-500 text-sm">Erro: Referência do banco não definida.</p>';
                return;
            }
            
            if (!currentUserProfile || currentUserProfile.role !== MANAGER_ROLE) {
                console.log("[DEBUG] Usuário não é gerente, não carregando colaboradores");
                if(collaboratorsListEl) collaboratorsListEl.innerHTML = '<p class="text-gray-500 text-sm italic">Apenas gerentes podem ver esta lista.</p>';
                return;
            }
            
            console.log("[DEBUG] Configurando listener para colaboradores...");
            
            if (unsubscribeCollaborators) {
                console.log("[DEBUG] Cancelando listener anterior de colaboradores");
                unsubscribeCollaborators();
            }

            try {
                unsubscribeCollaborators = onSnapshot(collaboratorsCollectionRef, 
                    (querySnapshot) => {
                        console.log("[DEBUG] Snapshot de colaboradores recebido");
                        console.log("[DEBUG] Número de colaboradores:", querySnapshot.size);
                        console.log("[DEBUG] Snapshot vazio?", querySnapshot.empty);
                        
                        allCollaboratorsCache = [];
                        querySnapshot.forEach((doc) => {
                            console.log("[DEBUG] Colaborador ID:", doc.id);
                            console.log("[DEBUG] Dados do colaborador:", doc.data());
                            allCollaboratorsCache.push({ id: doc.id, ...doc.data() });
                        });
                        
                        console.log("[DEBUG] Cache de colaboradores atualizado:", allCollaboratorsCache.length);
                        renderCollaboratorsList();
                    },
                    (error) => {
                        console.error("[DEBUG] Erro ao carregar colaboradores:", error);
                        console.error("[DEBUG] Código do erro:", error.code);
                        console.error("[DEBUG] Mensagem do erro:", error.message);
                        
                        if (collaboratorsListEl) {
                            let errorMessage = "Erro ao carregar colaboradores.";
                            if (error.code === 'permission-denied') {
                                errorMessage = "Sem permissão para ver colaboradores.";
                            }
                            collaboratorsListEl.innerHTML = `<p class="text-red-500 text-sm">${errorMessage}</p>`;
                        }
                    }
                );
            } catch (error) {
                console.error("[DEBUG] Erro ao configurar listener de colaboradores:", error);
                if (collaboratorsListEl) {
                    collaboratorsListEl.innerHTML = '<p class="text-red-500 text-sm">Erro de configuração.</p>';
                }
            }
        }

        window.openEditCollaboratorModal = function(collaboratorId) {
            if (!currentUserProfile || currentUserProfile.role !== MANAGER_ROLE) {
                showGenericModal("Acesso Negado", "Apenas gerentes podem editar colaboradores.");
                return;
            }
            const collab = allCollaboratorsCache.find(c => c.id === collaboratorId);
            if (!collab) {
                showGenericModal("Erro", "Colaborador não encontrado.");
                return;
            }

            if (editCollaboratorIdInputEl) editCollaboratorIdInputEl.value = collab.id;
            if (editCollabNameInputEl) editCollabNameInputEl.value = collab.name || '';
            if (editCollabEmailInputEl) editCollabEmailInputEl.value = collab.email || '';
            if (editCollabRoleSelectEl) {
                editCollabRoleSelectEl.value = collab.role || EMPLOYEE_ROLE;
                const managerCount = allCollaboratorsCache.filter(c => c.role === MANAGER_ROLE).length;
                if (collab.role === MANAGER_ROLE && managerCount <= 1 && collab.id === currentUserProfile.uid) { 
                    editCollabRoleSelectEl.disabled = true;
                } else {
                    editCollabRoleSelectEl.disabled = false;
                }
            }

            if (editCollabStagesCheckboxesEl) {
                editCollabStagesCheckboxesEl.innerHTML = ''; 
                ALL_POSSIBLE_STAGES.forEach(stage => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `edit-collab-stage-${stage.key}`;
                    checkbox.name = 'editCollabSelectedStages';
                    checkbox.value = stage.key;
                    checkbox.className = 'form-checkbox mr-2';
                    if (collab.departments && collab.departments.includes(stage.key)) {
                        checkbox.checked = true;
                    }
                    const label = document.createElement('label');
                    label.htmlFor = `edit-collab-stage-${stage.key}`;
                    label.textContent = stage.name;
                    label.className = 'text-sm';
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    editCollabStagesCheckboxesEl.appendChild(div);
                });
            }
            
            if (editCollaboratorModalEl) editCollaboratorModalEl.classList.remove('hidden');
        }

        window.closeEditCollaboratorModal = function() {
            if (editCollaboratorModalEl) editCollaboratorModalEl.classList.add('hidden');
        }

        async function handleUpdateCollaborator() {
            if (!currentUserProfile || currentUserProfile.role !== MANAGER_ROLE) {
                showGenericModal("Acesso Negado", "Apenas gerentes podem atualizar colaboradores.");
                return;
            }
            if (!editCollaboratorIdInputEl || !editCollabNameInputEl || !editCollabRoleSelectEl || !editCollabStagesCheckboxesEl) {
                 showGenericModal("Erro", "Elementos do formulário de edição não encontrados.");
                return;
            }

            const collaboratorId = editCollaboratorIdInputEl.value;
            const newName = editCollabNameInputEl.value.trim();
            const newRole = editCollabRoleSelectEl.value;
            const newSelectedDepartments = [];
            editCollabStagesCheckboxesEl.querySelectorAll('input[name="editCollabSelectedStages"]:checked').forEach(cb => {
                newSelectedDepartments.push(cb.value);
            });

            if (!newName) {
                showGenericModal("Erro de Validação", "O nome do colaborador não pode estar vazio.");
                return;
            }
            if (newRole === EMPLOYEE_ROLE && newSelectedDepartments.length === 0) {
                showGenericModal("Erro de Validação", "Colaboradores devem pertencer a pelo menos um departamento.");
                return;
            }

            const collaboratorBeingEdited = allCollaboratorsCache.find(c => c.id === collaboratorId);
            if (collaboratorBeingEdited && collaboratorBeingEdited.role === MANAGER_ROLE && newRole === EMPLOYEE_ROLE) {
                const managerCount = allCollaboratorsCache.filter(c => c.role === MANAGER_ROLE).length;
                if (managerCount <= 1 && collaboratorId === currentUserProfile.uid) { 
                    showGenericModal("Ação Não Permitida", "Você não pode alterar a função do único gerente para colaborador.");
                     if(editCollabRoleSelectEl) editCollabRoleSelectEl.value = MANAGER_ROLE; 
                    return;
                }
            }
            
            if (newRole === MANAGER_ROLE && !newSelectedDepartments.includes(MANAGER_REVIEW_STAGE_KEY)) {
                newSelectedDepartments.push(MANAGER_REVIEW_STAGE_KEY); 
            }


            const updateData = {
                name: newName,
                role: newRole,
                departments: newRole === MANAGER_ROLE ? [MANAGER_REVIEW_STAGE_KEY, ...ALL_POSSIBLE_STAGES.map(s => s.key)] : newSelectedDepartments
            };

            showLoading();
            try {
                const collabRef = doc(db, 'collaborators', collaboratorId);
                await updateDoc(collabRef, updateData);
                showToast(`Colaborador ${newName} atualizado.`, "success");
                closeEditCollaboratorModal();
            } catch (error) {
                console.error("Erro ao atualizar colaborador:", error);
                 if (error.code === 'permission-denied' || error.message.toLowerCase().includes('permission')) {
                    showGenericModal("Erro de Permissão", "Você não tem permissão para realizar esta alteração. Verifique as regras de segurança do Firestore ou contate o administrador.");
                } else {
                    showGenericModal("Erro", "Não foi possível atualizar o colaborador: " + error.message);
                }
            } finally {
                hideLoading();
            }
        }
        if(saveCollaboratorChangesBtnEl) saveCollaboratorChangesBtnEl.addEventListener('click', handleUpdateCollaborator);


        window.deleteCollaborator = function(collaboratorId) {
            const collab = allCollaboratorsCache.find(c => c.id === collaboratorId);
            if (!collab) return;
            
            if (collab.role === MANAGER_ROLE) {
                const managerCount = allCollaboratorsCache.filter(c => c.role === MANAGER_ROLE).length;
                if (managerCount <= 1) {
                    showGenericModal("Ação Não Permitida", "Não é possível excluir o único gerente do sistema.");
                    return;
                }
            }
            
            showGenericModal(
                "Confirmar Exclusão", 
                `Deseja excluir o colaborador <strong>${collab.name}</strong>?<br><small>Esta ação não pode ser desfeita.</small>`,
                [
                    { text: "Excluir", type: "danger", callback: () => deleteCollaboratorFromDb(collaboratorId) },
                    { text: "Cancelar", type: "secondary", callback: () => {} }
                ]
            );
        }

        async function deleteCollaboratorFromDb(collaboratorId) {
            if (!currentUserProfile || currentUserProfile.role !== MANAGER_ROLE) {
                showGenericModal("Acesso Negado", "Apenas gerentes podem excluir colaboradores.");
                return;
            }
            
            if (collaboratorId === currentUserProfile.uid) {
                showGenericModal("Erro", "Você não pode excluir sua própria conta.");
                return;
            }
            
            showLoading();
            try {
                const collabRef = doc(db, 'collaborators', collaboratorId);
                await deleteDoc(collabRef);
                showToast("Colaborador excluído.", "success");
            } catch (error) {
                console.error("Erro ao excluir colaborador:", error);
                showGenericModal("Erro", "Não foi possível excluir o colaborador: " + error.message);
            } finally {
                hideLoading();
            }
        }

        async function handleEstimateSubmission(orderId, stageKeyForEstimate) {
            const order = allOrdersCache.find(o => o.id === orderId);
            if (!order || order.orderPhase !== 'estimation' || !currentUserProfile || 
                !currentUserProfile.departments.includes(stageKeyForEstimate) || currentUserProfile.role === MANAGER_ROLE ) {
                 showGenericModal("Erro", "Não é possível submeter estimativa para este pedido/etapa agora ou você não tem permissão.");
                return;
            }

            const estimatedTimeInput = document.getElementById(`estTime-${order.id}-${stageKeyForEstimate}`);
            if (!estimatedTimeInput) {
                showGenericModal("Erro", "Campo de estimativa não encontrado.");
                return;
            }
            const estimatedMinutes = parseInt(estimatedTimeInput.value);

            if (isNaN(estimatedMinutes) || estimatedMinutes < 0) {
                showGenericModal("Erro", "Por favor, insira um tempo estimado válido para esta etapa.");
                return;
            }

            const timelineUpdate = { ...(order.timeline || {}) };
            if(!timelineUpdate[stageKeyForEstimate]) timelineUpdate[stageKeyForEstimate] = {};
            timelineUpdate[stageKeyForEstimate].estimatedMinutes = estimatedMinutes;
            timelineUpdate[stageKeyForEstimate].estimationSubmittedAt = new Date().toISOString();

            let allEstimatesSubmitted = true;
            for (const selectedStage of order.selectedStages) {
                if (!timelineUpdate[selectedStage] || timelineUpdate[selectedStage].estimatedMinutes === null) {
                    allEstimatesSubmitted = false;
                    break;
                }
            }
            
            let newOrderPhase = order.orderPhase;
            let newStatusForDB = order.status; 

            if (allEstimatesSubmitted) {
                newOrderPhase = 'manager_review';
                newStatusForDB = MANAGER_REVIEW_STAGE_KEY; 
            }
            
            showLoading();
            try {
                const orderRef = doc(ordersCollectionRef, orderId);
                await updateDoc(orderRef, { 
                    timeline: timelineUpdate,
                    status: newStatusForDB, 
                    orderPhase: newOrderPhase 
                });

                const employeeName = currentUserProfile.name.split(' ')[0];
                showToast(`Estimativa para ${getStatusTextForPDF(stageKeyForEstimate)} enviada.`, "success");

                // Notify manager(s) that an estimate was submitted
                const managers = allCollaboratorsCache.filter(c => c.role === MANAGER_ROLE);
                for (const manager of managers) {
                    await createNotification(
                        manager.id, 
                        `${employeeName} enviou estimativa para ${getStatusText(stageKeyForEstimate)} do pedido #${order.id.substring(0,5)} (${order.clientName}).`,
                        order.id,
                        'estimatesControl',
                        'estimate_submitted'
                    );
                }

                if (allEstimatesSubmitted) {
                    showToast(`Pedido #${order.id.substring(0,5)} pronto para revisão.`, "info");
                    for (const manager of managers) {
                        await createNotification(
                            manager.id, 
                            `Todas estimativas para o pedido #${order.id.substring(0,5)} (${order.clientName}) foram coletadas. Pronto para revisão.`,
                            order.id,
                            'myQueue', // Or 'estimatesControl'
                            'approval_needed'
                        );
                    }
                }
            } catch (error) {
                console.error("Erro ao enviar estimativa:", error);
                showGenericModal("Erro", "Não foi possível salvar a estimativa.");
            } finally {
                hideLoading();
            }
        }

        async function handleStartProduction(orderId, productionDate) {
            const order = allOrdersCache.find(o => o.id === orderId);
            if (!order || order.orderPhase !== 'manager_review' || !currentUserProfile || currentUserProfile.role !== MANAGER_ROLE) {
                 showGenericModal("Acesso Negado", "Apenas o Gerente de Produção pode iniciar a produção.");
                return;
            }

            if (!order.selectedStages || order.selectedStages.length === 0) {
                showGenericModal("Erro", "Nenhuma etapa de produção foi selecionada para este pedido.");
                return;
            }
            const firstProductionStageKey = order.selectedStages[0];
            const timelineUpdate = { ...(order.timeline || {}) };
            if(!timelineUpdate[firstProductionStageKey]) timelineUpdate[firstProductionStageKey] = {};
            
            showLoading();
            try {
                const orderRef = doc(ordersCollectionRef, orderId);
                await updateDoc(orderRef, {
                    orderPhase: 'production',
                    status: firstProductionStageKey, 
                    timeline: timelineUpdate, 
                    productionStartDate: productionDate 
                });
                
                showToast(`Produção do pedido #${order.id.substring(0,5)} iniciada.`, "success");

                // Notify employees responsible for the first stage
                const responsibleEmployees = allCollaboratorsCache.filter(c => 
                    c.role === EMPLOYEE_ROLE && c.departments && c.departments.includes(firstProductionStageKey)
                );
                for (const employee of responsibleEmployees) {
                    await createNotification(
                        employee.id,
                        `Pedido #${order.id.substring(0,5)} (${order.clientName}) atribuído a você para ${getStatusText(firstProductionStageKey)}.`,
                        order.id,
                        'myQueue',
                        'new_task'
                    );
                }

            } catch (error) {
                console.error("Erro ao iniciar produção:", error);
                showGenericModal("Erro", "Não foi possível iniciar a produção do pedido.");
            } finally {
                hideLoading();
            }
        }
        
        function promptForProductionStartDate(orderId) {
            const order = allOrdersCache.find(o => o.id === orderId);
            if (!order || order.orderPhase !== 'manager_review' || !currentUserProfile || currentUserProfile.role !== MANAGER_ROLE) {
                showGenericModal("Acesso Negado", "Ação não permitida.");
                return;
            }

            const today = new Date().toISOString().split('T')[0];

            showGenericModal(
                `Definir Início da Produção para Pedido #${order.id.substring(0,5)}`,
                null, 
                [
                    { 
                        text: "Confirmar e Iniciar Produção", 
                        type: "primary", 
                        callback: () => {
                            const dateInput = document.getElementById('productionStartDateInput');
                            if (!dateInput || !dateInput.value) {
                                showGenericModal("Erro", "Por favor, selecione uma data de início da produção.", [], 
                                `<p class="text-sm text-red-500 mb-2">Data inválida. Tente novamente.</p>`,
                                { closeOnClick: false } 
                                );
                                setTimeout(() => promptForProductionStartDate(orderId), 100); 
                                return false; 
                            }
                            const productionDate = dateInput.value;
                            handleStartProduction(orderId, productionDate); 
                        },
                        closeOnClick: true 
                    },
                    { text: "Cancelar", type: "secondary" }
                ],
                `<div class="space-y-4">
                    <p class="text-sm text-gray-700">Cliente: <span class="font-medium">${order.clientName}</span></p>
                    <div>
                        <label for="productionStartDateInput" class="block text-sm font-medium text-gray-700 mb-1">Data de Início da Produção:</label>
                        <input type="date" id="productionStartDateInput" class="form-input w-full" min="${today}">
                    </div>
                 </div>`
            );
        }

        async function advanceProductionStageOnDb(orderId, startDateString, startTimeString, endDateString, endTimeString) {
            const order = allOrdersCache.find(o => o.id === orderId);
            if (!order) {
                showGenericModal("Erro", "Pedido não encontrado para avançar etapa.");
                return;
            }

            const currentStageKey = order.status;
            const timelineUpdate = { ...order.timeline };
            
            const startDateTime = new Date(`${startDateString}T${startTimeString}`);
            const endDateTime = new Date(`${endDateString}T${endTimeString}`);

            if (isNaN(startDateTime.getTime()) || isNaN(endDateTime.getTime())) {
                closeGenericModal(); 
                showGenericModal("Erro de Validação", "As datas ou horas fornecidas são inválidas. Por favor, tente novamente.", [], null, {closeOnClick: false});
                setTimeout(() => handleAdvanceProduction(orderId), 100); 
                return;
            }

            if (endDateTime <= startDateTime) {
                closeGenericModal();
                showGenericModal("Erro de Validação", "O horário de término deve ser posterior ao horário de início. Por favor, corrija.", [], null, {closeOnClick: false});
                setTimeout(() => handleAdvanceProduction(orderId), 100); 
                return;
            }

            const actualMilliseconds = endDateTime.getTime() - startDateTime.getTime();
            const actualMinutes = Math.round(actualMilliseconds / (1000 * 60));

            if (!timelineUpdate[currentStageKey]) timelineUpdate[currentStageKey] = {};

            timelineUpdate[currentStageKey].productionStartTime = startDateTime.toISOString();
            timelineUpdate[currentStageKey].productionEndTime = endDateTime.toISOString();
            timelineUpdate[currentStageKey].actualMinutes = actualMinutes;

            const currentStageIndexInSelected = order.selectedStages.indexOf(currentStageKey);
            let nextStatusKey = '';
            let newOrderPhase = order.orderPhase;

            if (currentStageIndexInSelected < order.selectedStages.length - 1) {
                nextStatusKey = order.selectedStages[currentStageIndexInSelected + 1];
                if(!timelineUpdate[nextStatusKey]) timelineUpdate[nextStatusKey] = {};
                timelineUpdate[nextStatusKey].productionStartTime = new Date().toISOString(); 
            } else { 
                nextStatusKey = COMPLETED_STAGE_KEY; 
                newOrderPhase = 'completed';
            }
            
            showLoading();
            try {
                const orderRef = doc(ordersCollectionRef, orderId);
                await updateDoc(orderRef, {
                    status: nextStatusKey, 
                    orderPhase: newOrderPhase,
                    timeline: timelineUpdate
                });
                closeGenericModal(); 
                showToast(`Etapa ${getStatusText(currentStageKey)} concluída para pedido #${order.id.substring(0,5)}.`, "success");

                // Notify relevant users about the next step
                if (newOrderPhase === 'completed') {
                    const managers = allCollaboratorsCache.filter(c => c.role === MANAGER_ROLE);
                    for (const manager of managers) {
                        await createNotification(
                            manager.id,
                            `Pedido #${order.id.substring(0,5)} (${order.clientName}) foi concluído!`,
                            order.id,
                            'allOrders',
                            'order_update'
                        );
                    }
                } else { // Still in production, notify next stage's assignees
                    const responsibleEmployees = allCollaboratorsCache.filter(c => 
                        c.role === EMPLOYEE_ROLE && c.departments && c.departments.includes(nextStatusKey)
                    );
                    for (const employee of responsibleEmployees) {
                        await createNotification(
                            employee.id,
                            `Pedido #${order.id.substring(0,5)} (${order.clientName}) aguarda sua ação na etapa ${getStatusText(nextStatusKey)}.`,
                            order.id,
                            'myQueue',
                            'new_task'
                        );
                    }
                    // Also notify manager that a stage was completed
                    const managers = allCollaboratorsCache.filter(c => c.role === MANAGER_ROLE);
                    for (const manager of managers) {
                        await createNotification(
                            manager.id,
                            `Etapa ${getStatusText(currentStageKey)} concluída para #${order.id.substring(0,5)}. Próxima: ${getStatusText(nextStatusKey)}.`,
                            order.id,
                            'allOrders',
                            'order_update'
                        );
                    }
                }

            } catch (error) {
                console.error("Erro ao avançar etapa de produção:", error);
                closeGenericModal();
                showGenericModal("Erro", "Não foi possível avançar o pedido.");
            } finally {
                hideLoading();
            }
        }
        
        async function deleteSelectedOrdersFromDb() {
            if (selectedOrdersForDeletion.size === 0) {
                showGenericModal("Atenção", "Nenhum pedido selecionado para exclusão.");
                return;
            }

            showGenericModal(
                "Confirmar Exclusão em Massa",
                `Tem certeza que deseja excluir ${selectedOrdersForDeletion.size} pedido(s) selecionado(s)? Esta ação não pode ser desfeita.`,
                [
                    {
                        text: "Excluir Selecionados",
                        type: "danger",
                        callback: async () => {
                            showLoading();
                            let successCount = 0;
                            let errorCount = 0;
                            for (const orderId of selectedOrdersForDeletion) {
                                try {
                                    const orderRef = doc(ordersCollectionRef, orderId);
                                    await deleteDoc(orderRef);
                                    successCount++;
                                } catch (error) {
                                    console.error(`Erro ao excluir pedido ${orderId}:`, error);
                                    errorCount++;
                                }
                            }
                            hideLoading();
                            selectedOrdersForDeletion.clear();
                            toggleOrderSelectionMode(false); 
                            showToast(
                                `${successCount} pedido(s) excluído(s). ${errorCount > 0 ? errorCount + ' falha(s).' : ''}`,
                                errorCount > 0 ? "warning" : "success"
                            );
                        }
                    },
                    { text: "Cancelar", type: "secondary" }
                ]
            );
        }


        async function imageUrlToBase64(url) {
            if (!url || typeof url !== 'string' || !url.trim()) {
                console.warn("[DEBUG] URL da imagem inválida ou vazia fornecida para imageUrlToBase64:", url);
                return null; 
            }
            console.log(`[DEBUG] Tentando buscar imagem de: ${url}`);
            try {
                const response = await fetch(url, { mode: 'cors' }); 
                
                if (!response.ok) {
                    console.error(`[DEBUG] HTTP error ao buscar imagem: ${response.status} - ${response.statusText} para URL: ${url}`);
                     if (response.type === 'opaque') { 
                         console.warn(`[DEBUG] A resposta para ${url} foi opaca. Isso geralmente indica um problema de CORS onde o servidor não permite o acesso cross-origin.`);
                    }
                    return null; 
                }
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result); 
                    reader.onerror = (error) => {
                        console.error(`[DEBUG] Erro do FileReader ao converter blob da imagem de ${url}:`, error);
                        reject(error); 
                    };
                    reader.readAsDataURL(blob);
                });
            } catch (error) { 
                console.error(`[DEBUG] Falha CRÍTICA ao buscar ou processar imagem de ${url}. Erro: ${error.message}`, error);
                if (error instanceof TypeError && error.message.toLowerCase().includes("failed to fetch")) {
                     console.warn(`[DEBUG] DETALHE: O erro "Failed to fetch" para URLs externas como "${url}" é QUASE SEMPRE um problema de CORS (Cross-Origin Resource Sharing).
Isso significa que o servidor onde a imagem está hospedada (${new URL(url).hostname}) não permite que seu sistema (rodando em usercontent.goog ou similar) acesse a imagem diretamente via JavaScript.
Soluções possíveis (fora do controle deste código):
1. Configurar o servidor da imagem (${new URL(url).hostname}) para enviar o cabeçalho 'Access-Control-Allow-Origin: *' ou um valor que inclua a origem do seu sistema.
2. Se você tiver controle sobre o servidor da imagem, considere usar um proxy que adicione os cabeçalhos CORS.
3. Hospedar as imagens em um local que permita acesso CORS (ex: um bucket de armazenamento como o Firebase Storage, configurado para isso).
Este código NÃO PODE contornar as restrições de segurança CORS impostas pelo navegador e pelo servidor externo.`);
                }
                return null; 
            }
        }

        window.generateOrderPDF = async function(orderId) { 
            const order = allOrdersCache.find(o => o.id === orderId);
            if (!order) {
                showGenericModal("Erro", "Pedido não encontrado para gerar PDF.");
                return;
            }
            showLoading();

            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            doc.setFont("Helvetica"); 

            let y = 15; 
            const lineHeight = 7;
            const itemLineHeight = 5; 
            const margin = 10;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const usableWidth = pageWidth - 2 * margin;

            function checkAndAddPage(currentY, spaceNeeded = 20) {
                if (currentY > pageHeight - spaceNeeded) {
                    doc.addPage();
                    return 15; 
                }
                return currentY;
            }

            try { 
                if (COMPANY_LOGO_BASE64 && COMPANY_LOGO_BASE64 !== "COLE_AQUI_A_STRING_BASE64_DA_SUA_LOGO") {
                    try {
                        let imageType = 'PNG'; 
                        if (COMPANY_LOGO_BASE64.startsWith('data:image/jpeg;base64,') || COMPANY_LOGO_BASE64.startsWith('data:image/jpg;base64,')) {
                            imageType = 'JPEG';
                        }
                        const logoWidth = 47; 
                        const logoHeight = 10; 
                        doc.addImage(COMPANY_LOGO_BASE64, imageType, margin, y, logoWidth, logoHeight);
                        y += logoHeight + 5; 
                    } catch (e) {
                        console.error("Erro ao adicionar logo da empresa ao PDF:", e);
                    }
                }

                doc.setFontSize(16);
                doc.text(`Detalhes do Pedido: #${order.id.substring(0,8)}`, margin, y);
                y += lineHeight * 1.5;

                doc.setFontSize(11);
                doc.text(`Cliente: ${order.clientName || 'N/A'}`, margin, y); y += lineHeight;
                doc.text(`Criado em: ${formatDateTime(order.createdAt)}`, margin, y); y += lineHeight; 
                if(order.productionStartDate) { 
                     doc.text(`Data de Início Produção: ${formatDate(order.productionStartDate)}`, margin, y); y += lineHeight;
                }
                doc.text(`Data de Entrega: ${formatDate(order.deliveryDate)}`, margin, y); y += lineHeight;
                doc.text(`Prioridade: ${(order.priority || 'normal').toUpperCase()}`, margin, y); y += lineHeight;
                
                if (order.coverImageUrl && order.coverImageUrl.trim() !== "") {
                    y = checkAndAddPage(y, 40); 
                    doc.setFontSize(10);
                    doc.text("Imagem de Referência:", margin, y);
                    y += itemLineHeight;
                    let imgData = null; 
                    try {
                        imgData = await imageUrlToBase64(order.coverImageUrl);
                        if (imgData) { 
                            const imgProps = doc.getImageProperties(imgData);
                            const imgWidth = usableWidth / 2; 
                            const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                            
                            y = checkAndAddPage(y, imgHeight + itemLineHeight); 

                            doc.addImage(imgData, imgProps.fileType.toUpperCase(), margin, y, imgWidth, imgHeight); 
                            y += imgHeight + itemLineHeight;
                        } else {
                            doc.text(`Falha ao carregar imagem: ${order.coverImageUrl}`, margin, y);
                            y += itemLineHeight;
                            doc.setFontSize(8);
                            doc.setTextColor(100); 
                            doc.text(`(Verifique URL, conexão e permissões CORS do servidor da imagem.)`, margin, y);
                            y += itemLineHeight * (doc.splitTextToSize(order.coverImageUrl, usableWidth).length);
                            doc.setTextColor(50,50,50); 
                            doc.setFontSize(10); 
                        }
                    } catch (e) { 
                        console.error("Erro ao processar ou adicionar imagem da capa ao PDF:", e);
                        doc.text(`Erro ao processar imagem: ${order.coverImageUrl}`, margin, y);
                        y += itemLineHeight;
                        doc.setFontSize(8);
                        doc.setTextColor(100);
                        doc.text(`(Verifique URL, conexão e permissões CORS do servidor da imagem.)`, margin, y);
                        y += itemLineHeight * (doc.splitTextToSize(order.coverImageUrl, usableWidth).length);
                        doc.setTextColor(50,50,50); 
                        doc.setFontSize(10); 
                    }
                } else {
                    y = checkAndAddPage(y, itemLineHeight + 2);
                    doc.setFontSize(10);
                    doc.text("Imagem de Referência: Nenhuma fornecida", margin, y);
                    y += itemLineHeight;
                }
                
                y += lineHeight * 0.5;
                y = checkAndAddPage(y, 60); 

                doc.setFontSize(12);
                doc.text("Itens do Pedido:", margin, y);
                y += lineHeight;
                doc.setFontSize(10);
                if (order.items && order.items.length > 0) {
                    order.items.forEach((item, index) => {
                        y = checkAndAddPage(y, itemLineHeight + 2);
                        doc.text(` Item ${index + 1}: ${item.quantity}x ${item.material} (${item.width}cm x ${item.height}cm)`, margin + 5, y);
                        y += itemLineHeight;
                    });
                } else {
                    doc.text("Nenhum item especificado.", margin + 5, y);
                    y += itemLineHeight;
                }
                y += lineHeight * 0.7;
                y = checkAndAddPage(y, 60); 

                doc.setFontSize(12);
                doc.text("Etapas Selecionadas para Produção:", margin, y);
                y += lineHeight;
                doc.setFontSize(10);
                if (order.selectedStages && order.selectedStages.length > 0) {
                    const stagesText = order.selectedStages.map(stageKey => getStatusTextForPDF(stageKey)).join(', ');
                    const stagesLines = doc.splitTextToSize(stagesText, usableWidth - 5); 
                    y = checkAndAddPage(y, stagesLines.length * itemLineHeight + 2);
                    doc.text(stagesLines, margin + 5, y);
                    y += stagesLines.length * itemLineHeight;
                } else {
                    doc.text("Nenhuma etapa de produção específica selecionada.", margin + 5, y);
                    y += itemLineHeight;
                }
                y += lineHeight * 0.7;
                

                if (order.description) {
                    doc.setFontSize(11);
                    doc.text("Observações Gerais (Pedido):", margin, y);
                    y += lineHeight * 0.8;
                    doc.setFontSize(10);
                    const descLines = doc.splitTextToSize(order.description, usableWidth - 5);
                    y = checkAndAddPage(y, descLines.length * lineHeight * 0.7 + lineHeight * 0.5 + 5);
                    doc.text(descLines, margin + 5, y);
                    y += descLines.length * lineHeight * 0.7 + lineHeight * 0.5;
                }
                
                y = checkAndAddPage(y, 80); 
                y += lineHeight; 

                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Controle de Qualidade", pageWidth / 2, y, { align: 'center' });
                doc.setFont(undefined, 'normal');
                y += lineHeight * 1.5;

                const qcItems = [
                    "Visual (impressão)",
                    "Resina (espessura/defeitos)",
                    "Corte (acabamento/borda)",
                    "Conferência de quantidade",
                    "Embalagem final"
                ];

                const colWidths = {
                    item: usableWidth * 0.35,      
                    responsavel: usableWidth * 0.20, 
                    ok: usableWidth * 0.08,         
                    nok: usableWidth * 0.08,        
                    observacoes: usableWidth * 0.29 
                };
                
                const cellPadding = 2;
                const headerLineHeight = itemLineHeight * 1.5; 
                const rowLineHeight = itemLineHeight * 2;   

                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                let currentX = margin;
                doc.rect(currentX, y, colWidths.item, headerLineHeight); doc.text("Item", currentX + cellPadding, y + itemLineHeight);
                currentX += colWidths.item;
                doc.rect(currentX, y, colWidths.responsavel, headerLineHeight); doc.text("Responsável", currentX + cellPadding, y + itemLineHeight);
                currentX += colWidths.responsavel;
                doc.rect(currentX, y, colWidths.ok, headerLineHeight); doc.text("OK", currentX + cellPadding, y + itemLineHeight);
                currentX += colWidths.ok;
                doc.rect(currentX, y, colWidths.nok, headerLineHeight); doc.text("NOK", currentX + cellPadding, y + itemLineHeight);
                currentX += colWidths.nok;
                doc.rect(currentX, y, colWidths.observacoes, headerLineHeight); doc.text("Observações", currentX + cellPadding, y + itemLineHeight);
                y += headerLineHeight;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);

                qcItems.forEach(item => {
                    y = checkAndAddPage(y, rowLineHeight + 2);
                    currentX = margin;
                    doc.rect(currentX, y, colWidths.item, rowLineHeight); 
                    const itemTextLines = doc.splitTextToSize(item, colWidths.item - 2 * cellPadding);
                    doc.text(itemTextLines, currentX + cellPadding, y + itemLineHeight - (itemTextLines.length > 1 ? 1 : 0) ); 
                    
                    currentX += colWidths.item;
                    doc.rect(currentX, y, colWidths.responsavel, rowLineHeight); 
                    currentX += colWidths.responsavel;
                    doc.rect(currentX, y, colWidths.ok, rowLineHeight);        
                    currentX += colWidths.ok;
                    doc.rect(currentX, y, colWidths.nok, rowLineHeight);       
                    currentX += colWidths.nok;
                    doc.rect(currentX, y, colWidths.observacoes, rowLineHeight); 
                    y += rowLineHeight;
                });

                y += lineHeight * 0.5;
                y = checkAndAddPage(y, 40); 

                doc.setFontSize(10);
                doc.text("Observações (preenchimento manual):", margin, y);
                y += itemLineHeight;
                const obsBoxHeight = itemLineHeight * 5; 
                doc.rect(margin, y, usableWidth, obsBoxHeight);
                for (let i = 1; i < 5; i++) {
                     doc.line(margin, y + (itemLineHeight * i), margin + usableWidth, y + (itemLineHeight*i));
                }
                y += obsBoxHeight + lineHeight;

                doc.save(`pedido_${order.id.substring(0,8)}_${(order.clientName || 'cliente').replace(/\s+/g, '_')}.pdf`);
                showToast("PDF do pedido gerado.", "success");

            } catch (pdfError) {
                console.error("Erro durante a geração do PDF:", pdfError);
                showGenericModal("Erro no PDF", "Ocorreu um erro inesperado ao gerar o PDF.");
            } finally {
                hideLoading();
            }
        }
        
        // --- Lógica de Autenticação e UI ---
        function updateUserAccessUI() {
            console.log("[DEBUG] updateUserAccessUI chamada. currentUserProfile:", currentUserProfile);
            if (!currentUserProfile || !navNewOrderBtnEl || !navUserManagementBtnEl || !navEstimatesControlBtnEl || !navDashboardBtnEl || !toggleOrderSelectionModeBtnEl || !deleteSelectedOrdersBtnEl || !generateDescriptionBtnEl || !calendarModeToggleContainerEl) {
                console.warn("[DEBUG] updateUserAccessUI: Perfil não carregado ou botões de navegação/exclusão/gerar descrição/toggle calendário não encontrados.");
                if(navDashboardBtnEl) navDashboardBtnEl.style.display = 'none';
                if(navNewOrderBtnEl) navNewOrderBtnEl.style.display = 'none';
                if(navUserManagementBtnEl) navUserManagementBtnEl.style.display = 'none';
                if(navEstimatesControlBtnEl) navEstimatesControlBtnEl.style.display = 'none';
                if(toggleOrderSelectionModeBtnEl) toggleOrderSelectionModeBtnEl.classList.add('hidden');
                if(deleteSelectedOrdersBtnEl) deleteSelectedOrdersBtnEl.classList.add('hidden');
                if(generateDescriptionBtnEl) generateDescriptionBtnEl.classList.add('hidden');
                if(calendarModeToggleContainerEl) calendarModeToggleContainerEl.classList.add('hidden');
                if(notificationBellContainerEl) notificationBellContainerEl.classList.add('hidden');


                if (appContentEl && !appContentEl.classList.contains('hidden') && loginSectionEl) {
                    console.log("[DEBUG] updateUserAccessUI: Escondendo appContent, mostrando loginSection.");
                    appContentEl.classList.add('hidden');
                    loginSectionEl.classList.remove('hidden');
                }
                return;
            }

            const isManager = currentUserProfile.role === MANAGER_ROLE;
            console.log("[DEBUG] updateUserAccessUI - isManager:", isManager);
            
            navDashboardBtnEl.style.display = isManager ? 'flex' : 'none'; 
            navNewOrderBtnEl.style.display = isManager ? 'flex' : 'none';
            navUserManagementBtnEl.style.display = isManager ? 'flex' : 'none';
            navEstimatesControlBtnEl.style.display = isManager ? 'flex' : 'none';
            generateDescriptionBtnEl.classList.toggle('hidden', !isManager);
            calendarModeToggleContainerEl.classList.toggle('hidden', !isManager);
            
            toggleOrderSelectionModeBtnEl.classList.toggle('hidden', !isManager);
            deleteSelectedOrdersBtnEl.classList.add('hidden'); 
            deleteSelectedOrdersBtnEl.disabled = true;
            
            if(notificationBellContainerEl) notificationBellContainerEl.classList.remove('hidden');


            if (isManager && orderItemsContainerEl && document.getElementById('newOrderSection') && 
                document.getElementById('newOrderSection').classList.contains('active') && 
                orderItemsContainerEl.children.length === 0) {
                 console.log("[DEBUG] updateUserAccessUI: Adicionando primeiro item ao formulário de Novo Pedido.");
                 addOrderItem(true);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            console.log("[DEBUG] onAuthStateChanged - user:", user ? user.uid : null);
            showLoading();
            if (user) {
                currentAuthUser = user;
                if (authUserIdGlobalEl) authUserIdGlobalEl.textContent = user.uid.substring(0,8) + "...";
                
                const userProfileRef = doc(db, `collaborators`, user.uid);
                try {
                    const userProfileSnap = await getDoc(userProfileRef);
                    if (userProfileSnap.exists()) {
                        currentUserProfile = { uid: user.uid, ...userProfileSnap.data() };
                        console.log("[DEBUG] Perfil do usuário carregado com sucesso:", currentUserProfile);
                        if(userNameDisplayEl) userNameDisplayEl.textContent = currentUserProfile.name || currentUserProfile.email;
                        if(userInfoEl) userInfoEl.classList.remove('hidden');
                        if(loginSectionEl) loginSectionEl.classList.add('hidden');
                        if(appContentEl) appContentEl.classList.remove('hidden');
                        
                        ordersCollectionRef = collection(db, `artifacts/${internalAppId}/production_orders`);
                        collaboratorsCollectionRef = collection(db, `collaborators`);
                        notificationsCollectionRef = collection(db, `notifications`); // Init notifications ref

                        updateUserAccessUI(); 
                        loadOrdersFromFirestore(); 
                        listenForNotifications(); // Start listening for notifications
                        if (currentUserProfile.role === MANAGER_ROLE) {
                            loadCollaborators(); 
                        }
                        
                        const activeNavAfterUIUpdate = document.querySelector('#mainNavigation button.nav-link.active');
                        if(!activeNavAfterUIUpdate){ 
                            if (currentUserProfile.role === MANAGER_ROLE) {
                                if (navDashboardBtnEl && navDashboardBtnEl.style.display !== 'none') {
                                    console.log("[DEBUG] onAuthStateChanged (Gerente): Nenhuma aba ativa, ativando Dashboard.");
                                    navDashboardBtnEl.click(); 
                                } else {
                                    const firstVisibleNav = document.querySelector('#mainNavigation button.nav-link:not([style*="display: none"])');
                                    if (firstVisibleNav) {
                                        console.log("[DEBUG] onAuthStateChanged (Gerente): Dashboard não visível, ativando primeira aba visível:", firstVisibleNav.dataset.section);
                                        firstVisibleNav.click();
                                    }
                                }
                            } else { 
                                if (navMyQueueBtnEl && navMyQueueBtnEl.style.display !== 'none') {
                                    console.log("[DEBUG] onAuthStateChanged (Colaborador): Nenhuma aba ativa, ativando Minha Fila.");
                                    navMyQueueBtnEl.click();
                                } else {
                                    const firstVisibleNav = document.querySelector('#mainNavigation button.nav-link:not([style*="display: none"])');
                                    if (firstVisibleNav) {
                                        console.log("[DEBUG] onAuthStateChanged (Colaborador): Minha Fila não visível, ativando primeira aba visível:", firstVisibleNav.dataset.section);
                                        firstVisibleNav.click();
                                    }
                                }
                            }
                             if (!document.querySelector('#mainNavigation button.nav-link.active')) {
                                console.error("[DEBUG] onAuthStateChanged: Nenhuma aba visível para ativar após login para o perfil:", currentUserProfile.role);
                            }
                        } else {
                            console.log("[DEBUG] onAuthStateChanged: Aba ativa já definida:", activeNavAfterUIUpdate.dataset.section);
                        }

                    } else {
                        console.warn("[DEBUG] Perfil do usuário não encontrado no Firestore para UID:", user.uid, ". Deslogando.");
                        if(auth) await signOut(auth); 
                    }
                } catch (error) {
                    console.error("[DEBUG] Erro ao buscar perfil do usuário:", error);
                    if(auth) await signOut(auth);
                }

            } else { 
                console.log("[DEBUG] Nenhum usuário logado. Mostrando tela de login.");
                currentAuthUser = null;
                currentUserProfile = null;
                if(userNameDisplayEl) userNameDisplayEl.textContent = '';
                if(userInfoEl) userInfoEl.classList.add('hidden');
                if(loginSectionEl) loginSectionEl.classList.remove('hidden');
                if(appContentEl) appContentEl.classList.add('hidden');
                if (authUserIdGlobalEl) authUserIdGlobalEl.textContent = "N/A";
                if (unsubscribeOrders) unsubscribeOrders();
                if (unsubscribeCollaborators) unsubscribeCollaborators();
                if (unsubscribeNotifications) unsubscribeNotifications(); // Stop listening on logout
                allOrdersCache = [];
                allCollaboratorsCache = [];
                userNotificationsCache = [];
                if(allOrdersTableBodyEl) renderAllOrdersTable(); 
                if(myQueueEstimationListEl && myQueueProductionListEl && myQueueTitleEl) renderMyQueue();
                if(timeDashboardContainerEl && dashboardTitleEl && currentUserProfile && currentUserProfile.role === MANAGER_ROLE) renderTimeDashboard();
                if(dailyLoadReportContainerEl) renderDailyProductionLoadReport();
                if(notificationBellContainerEl) notificationBellContainerEl.classList.add('hidden');
                if(notificationDropdownEl) notificationDropdownEl.classList.add('hidden');
            }
            hideLoading();
        });

        // --- Event Listeners ---
        if (loginFormEl) {
            loginFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();
                if(loginErrorEl) loginErrorEl.classList.add('hidden');
                const email = loginFormEl.loginEmail.value;
                const password = loginFormEl.loginPassword.value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    console.log("[DEBUG] Tentativa de login bem-sucedida para:", email);
                    showToast(`Bem-vindo de volta!`, "success");
                } catch (error) {
                    console.error("[DEBUG] Erro no login:", error.code, error.message);
                    if(loginErrorEl) {
                        if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                            loginErrorEl.textContent = "Email ou senha inválidos. Verifique seus dados.";
                        } else {
                            loginErrorEl.textContent = "Falha no login: " + error.message; 
                        }
                        loginErrorEl.classList.remove('hidden');
                    }
                     showToast("Falha no login.", "error");
                } finally {
                    hideLoading();
                }
            });
        }

        if (logoutBtnEl) {
            logoutBtnEl.addEventListener('click', async () => {
                console.log("[DEBUG] LogoutBtn clicado");
                showLoading();
                try {
                    await signOut(auth);
                    showToast("Você saiu do sistema.", "info");
                } catch (error) {
                    console.error("[DEBUG] Erro no logout:", error);
                    showGenericModal("Erro", "Falha ao fazer logout.");
                } finally {
                    hideLoading();
                }
            });
        }
        
        if (collabStagesCheckboxesEl) { 
            ALL_POSSIBLE_STAGES.forEach(stage => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `collab-stage-${stage.key}`;
                checkbox.name = 'collabSelectedStages';
                checkbox.value = stage.key;
                checkbox.className = 'form-checkbox mr-2';
                const label = document.createElement('label');
                label.htmlFor = `collab-stage-${stage.key}`;
                label.textContent = stage.name;
                label.className = 'text-sm';
                div.appendChild(checkbox);
                div.appendChild(label);
                collabStagesCheckboxesEl.appendChild(div);
            });
        }

        if(addCollaboratorFormEl) {
            addCollaboratorFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log("[DEBUG] Formulário de adicionar colaborador submetido.");
                if (!currentUserProfile || currentUserProfile.role !== MANAGER_ROLE) {
                    showGenericModal("Acesso Negado", "Apenas gerentes podem adicionar colaboradores.");
                    return;
                }

                const name = addCollaboratorFormEl.collabName.value;
                const email = addCollaboratorFormEl.collabEmail.value;
                const password = addCollaboratorFormEl.collabPassword.value;
                const role = addCollaboratorFormEl.collabRole.value;
                const selectedDepartments = [];
                collabStagesCheckboxesEl.querySelectorAll('input[name="collabSelectedStages"]:checked').forEach(cb => {
                    selectedDepartments.push(cb.value);
                });

                if (password.length < 6) {
                    showGenericModal("Erro", "A senha inicial deve ter pelo menos 6 caracteres.");
                    return;
                }
                if (selectedDepartments.length === 0 && role === EMPLOYEE_ROLE) {
                    showGenericModal("Atenção", "Selecione pelo menos um departamento para o colaborador.");
                    return;
                }
                
                showLoading();
                try {
                    console.log("[DEBUG] Tentando criar utilizador no Auth:", email);
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const newUserId = userCredential.user.uid;
                    console.log("[DEBUG] Utilizador criado no Auth com UID:", newUserId);

                    console.log("[DEBUG] Tentando criar perfil no Firestore para UID:", newUserId);
                    await setDoc(doc(db, 'collaborators', newUserId), {
                        name: name,
                        email: email,
                        role: role,
                        departments: role === MANAGER_ROLE ? [MANAGER_REVIEW_STAGE_KEY, ...ALL_POSSIBLE_STAGES.map(s => s.key)] : selectedDepartments,
                        uid: newUserId 
                    });
                    console.log("[DEBUG] Perfil criado no Firestore para:", name);

                    addCollaboratorFormEl.reset();
                    collabStagesCheckboxesEl.querySelectorAll('input').forEach(cb => cb.checked = false);
                    showToast(`Colaborador ${name} adicionado.`, "success");
                    loadCollaborators(); 
                } catch (error) {
                    console.error("Erro ao adicionar colaborador:", error.code, error.message);
                    showGenericModal("Erro", `Não foi possível adicionar o colaborador: ${error.message}`);
                } finally {
                    hideLoading();
                }
            });
        }
        
        if (orderFormEl) {
            orderFormEl.addEventListener('submit', async function(e) {
                e.preventDefault();
                if (!currentUserProfile || currentUserProfile.role !== MANAGER_ROLE) {
                    showGenericModal("Acesso Negado", "Apenas gerentes podem criar pedidos.");
                    return;
                }
                
                const selectedStagesKeys = [];
                productionStagesCheckboxesEl.querySelectorAll('input[name="selectedStages"]:checked').forEach(checkbox => {
                    selectedStagesKeys.push(checkbox.value);
                });

                if (selectedStagesKeys.length === 0) {
                    showGenericModal("Atenção", "Por favor, selecione pelo menos uma etapa de produção para o pedido geral.");
                    return;
                }

                const items = [];
                const itemCards = orderItemsContainerEl.querySelectorAll('.card');
                if (itemCards.length === 0) {
                    showGenericModal("Atenção", "Adicione pelo menos um item ao pedido.");
                    return;
                }

                let itemsValid = true;
                itemCards.forEach(card => {
                    const material = card.querySelector('input[name="item_material"]').value;
                    const quantity = parseInt(card.querySelector('input[name="item_quantity"]').value);
                    const width = parseFloat(card.querySelector('input[name="item_width"]').value);
                    const height = parseFloat(card.querySelector('input[name="item_height"]').value);
                    if (!material || isNaN(quantity) || quantity <=0 || isNaN(width) || width <=0 || isNaN(height) || height <=0) {
                        itemsValid = false;
                    }
                    items.push({ material, quantity, width, height });
                });

                if (!itemsValid) {
                    showGenericModal("Erro nos Itens", "Verifique se todos os campos dos itens (material, quantidade, largura, altura) estão preenchidos corretamente.");
                    return;
                }

                const orderData = {
                    clientName: document.getElementById('clientName').value,
                    deliveryDate: document.getElementById('deliveryDate').value,
                    productionStartDate: null, 
                    priority: document.getElementById('priority').value,
                    coverImageUrl: document.getElementById('coverImageUrl').value.trim(),
                    description: document.getElementById('description').value, 
                    selectedStages: selectedStagesKeys, 
                    items: items, 
                    status: 'estimation', 
                    orderPhase: 'estimation', 
                    createdAt: new Date().toISOString(),
                    createdBy: { uid: currentUserProfile.uid, name: currentUserProfile.name || currentUserProfile.email },
                    appId: internalAppId,
		    timeline: ALL_POSSIBLE_STAGES.reduce((acc, stage) => {
                        acc[stage.key] = { 
                            estimatedMinutes: null, estimationSubmittedAt: null,
                            productionStartTime: null, actualMinutes: null, productionEndTime: null 
                        };
                        return acc;
                    }, {}),
                };

                showLoading();
                try {
                    const newOrderRef = await addDoc(ordersCollectionRef, orderData);
                    const newOrderId = newOrderRef.id;

                    this.reset(); 
                    if (orderItemsContainerEl) { 
                        orderItemsContainerEl.innerHTML = '';
                        addOrderItem(true);
                    }
                    productionStagesCheckboxesEl.querySelectorAll('input').forEach(cb => cb.checked = false);
                    const deliveryDateInput = document.getElementById('deliveryDate');
                    if(deliveryDateInput) deliveryDateInput.min = new Date().toISOString().split("T")[0];
                    
                    showToast(`Pedido para ${orderData.clientName} criado.`, "success");

                    // Notify relevant employees for estimation
                    const employeesToNotify = new Set();
                    orderData.selectedStages.forEach(stageKey => {
                        allCollaboratorsCache.forEach(collab => {
                            if (collab.role === EMPLOYEE_ROLE && collab.departments && collab.departments.includes(stageKey)) {
                                employeesToNotify.add(collab.id);
                            }
                        });
                    });

                    employeesToNotify.forEach(employeeId => {
                        createNotification(
                            employeeId,
                            `Novo pedido #${newOrderId.substring(0,5)} (${orderData.clientName}) requer sua estimativa.`,
                            newOrderId,
                            'myQueue',
                            'estimate_needed'
                        );
                    });
                    // Notify manager(s) about the new order needing estimates
                    const managers = allCollaboratorsCache.filter(c => c.role === MANAGER_ROLE);
                     for (const manager of managers) {
                        await createNotification(
                            manager.id, 
                            `Novo pedido #${newOrderId.substring(0,5)} (${orderData.clientName}) criado e aguardando estimativas.`,
                            newOrderId,
                            'estimatesControl', // Manager can see it here
                            'order_update'
                        );
                    }


                } catch (error) {
                    console.error("Erro ao adicionar pedido: ", error);
                    showGenericModal('Erro Inesperado', 'Não foi possível adicionar o pedido.');
                } finally {
                    hideLoading();
                }
            });
        }
        
        if (productionStagesCheckboxesEl) { 
            ALL_POSSIBLE_STAGES.forEach(stage => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `stage-${stage.key}`;
                checkbox.name = 'selectedStages';
                checkbox.value = stage.key;
                checkbox.className = 'form-checkbox mr-2';
                const label = document.createElement('label');
                label.htmlFor = `stage-${stage.key}`;
                label.textContent = stage.name;
                label.className = 'text-sm';
                div.appendChild(checkbox);
                div.appendChild(label);
                productionStagesCheckboxesEl.appendChild(div);
            });
        }

        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                console.log("[DEBUG] Nav link clicado:", link.dataset.section); 

                if (link.id === 'navNewOrderBtn' && (!currentUserProfile || currentUserProfile.role !== MANAGER_ROLE)) {
                    showGenericModal("Acesso Negado", "Apenas o Gerente de Produção pode criar novos pedidos.");
                    console.log("[DEBUG] Acesso negado para Novo Pedido"); 
                    return; 
                }
                if (link.id === 'navUserManagementBtn' && (!currentUserProfile || currentUserProfile.role !== MANAGER_ROLE)) {
                    showGenericModal("Acesso Negado", "Apenas o Gerente de Produção pode gerir colaboradores.");
                    console.log("[DEBUG] Acesso negado para Gestão de Colaboradores"); 
                    return;
                }
                if (link.id === 'navEstimatesControlBtn' && (!currentUserProfile || currentUserProfile.role !== MANAGER_ROLE)) {
                    showGenericModal("Acesso Negado", "Apenas o Gerente de Produção pode acessar o controle de estimativas.");
                    console.log("[DEBUG] Acesso negado para Controle de Estimativas"); 
                    return;
                }
                 if (link.id === 'navDashboardBtn' && (!currentUserProfile || currentUserProfile.role !== MANAGER_ROLE)) {
                    showGenericModal("Acesso Negado", "Apenas gerentes podem acessar o Dashboard.");
                    console.log("[DEBUG] Acesso negado para Dashboard (Colaborador)");
                    return; 
                }


                const sectionId = link.dataset.section + "Section";
                console.log("[DEBUG] Tentando ativar seção ID:", sectionId); 

                sections.forEach(section => section.classList.add('hidden'));
                navLinks.forEach(nav => nav.classList.remove('active'));
                
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                    console.log("[DEBUG] Seção exibida:", sectionId); 
                } else {
                    console.error("[DEBUG] Seção não encontrada:", sectionId); 
                }
                link.classList.add('active');

                if (isOrderSelectionModeActive && sectionId !== 'allOrdersSection') {
                    toggleOrderSelectionMode(false); 
                } else if (sectionId === 'allOrdersSection') {
                    renderAllOrdersTable();
                }


                if (sectionId === 'dashboardSection' && currentUserProfile && currentUserProfile.role === MANAGER_ROLE) { console.log("[DEBUG] Chamando renderTimeDashboard"); renderTimeDashboard(); } 
                if (sectionId === 'estimatesControlSection' && currentUserProfile && currentUserProfile.role === MANAGER_ROLE) { 
                    console.log("[DEBUG] Chamando renderEstimatesControl"); 
                    renderEstimatesControl(); 
                }
                if (sectionId === 'reportsSection') { 
                    console.log("[DEBUG] Chamando renderDailyProductionLoadReport (para lista e dados do calendário)"); 
                    renderDailyProductionLoadReport(); 
                    if(dailyLoadReportListContainerEl) dailyLoadReportListContainerEl.classList.remove('hidden');
                    if(calendarViewContainerEl) calendarViewContainerEl.classList.add('hidden');
                    if(reportViewListBtnEl) reportViewListBtnEl.classList.add('btn-primary');
                    if(reportViewListBtnEl) reportViewListBtnEl.classList.remove('btn-secondary');
                    if(reportViewCalendarBtnEl) reportViewCalendarBtnEl.classList.remove('btn-primary');
                    if(reportViewCalendarBtnEl) reportViewCalendarBtnEl.classList.add('btn-secondary');
                    if(calendarModeToggleContainerEl) calendarModeToggleContainerEl.classList.add('hidden'); 
                } 
                if (sectionId === 'newOrderSection' && orderItemsContainerEl && orderItemsContainerEl.children.length === 0 && currentUserProfile && currentUserProfile.role === MANAGER_ROLE) {
                    console.log("[DEBUG] Adicionando primeiro item ao novo pedido"); addOrderItem(true); 
                }
                if (sectionId === 'myQueueSection') { console.log("[DEBUG] Chamando renderMyQueue"); renderMyQueue(); } 
                if (sectionId === 'userManagementSection' && currentUserProfile && currentUserProfile.role === MANAGER_ROLE) { 
                    console.log("[DEBUG] Navegando para Gestão de Colaboradores");
                    console.log("[DEBUG] Forçando carregamento de colaboradores");
                    loadCollaborators(); 
                } 
            });
        });

        if (addOrderItemBtnEl) {
            addOrderItemBtnEl.addEventListener('click', () => addOrderItem(false));
        }

        if (orderFilterInputEl) orderFilterInputEl.addEventListener('keyup', renderAllOrdersTable);
        if (clearOrderFilterBtnEl) clearOrderFilterBtnEl.addEventListener('click', () => {
            if (orderFilterInputEl) orderFilterInputEl.value = '';
            renderAllOrdersTable(); 
        });
        if (dashboardFilterInputEl) dashboardFilterInputEl.addEventListener('keyup', renderTimeDashboard);
        if (clearDashboardFilterBtnEl) clearDashboardFilterBtnEl.addEventListener('click', () => {
            if (dashboardFilterInputEl) dashboardFilterInputEl.value = '';
            renderTimeDashboard();
        });
        if (myQueueFilterInputEl) myQueueFilterInputEl.addEventListener('keyup', renderMyQueue); 
        if (clearMyQueueFilterBtnEl) clearMyQueueFilterBtnEl.addEventListener('click', () => {
            if (myQueueFilterInputEl) myQueueFilterInputEl.value = '';
            renderMyQueue();
        });
        if (estimatesControlFilterInputEl) estimatesControlFilterInputEl.addEventListener('keyup', renderEstimatesControl);
        if (clearEstimatesControlFilterBtnEl) clearEstimatesControlFilterBtnEl.addEventListener('click', () => {
            if (estimatesControlFilterInputEl) estimatesControlFilterInputEl.value = '';
            renderEstimatesControl();
        });

        if(reportViewListBtnEl) {
            reportViewListBtnEl.addEventListener('click', () => {
                if(dailyLoadReportListContainerEl) dailyLoadReportListContainerEl.classList.remove('hidden');
                if(calendarViewContainerEl) calendarViewContainerEl.classList.add('hidden');
                reportViewListBtnEl.classList.add('btn-primary');
                reportViewListBtnEl.classList.remove('btn-secondary');
                if(reportViewCalendarBtnEl) reportViewCalendarBtnEl.classList.remove('btn-primary');
                if(reportViewCalendarBtnEl) reportViewCalendarBtnEl.classList.add('btn-secondary');
                if(calendarModeToggleContainerEl) calendarModeToggleContainerEl.classList.add('hidden'); 
                renderDailyProductionLoadReport(); 
            });
        }
        if(reportViewCalendarBtnEl) {
            reportViewCalendarBtnEl.addEventListener('click', () => {
                if(dailyLoadReportListContainerEl) dailyLoadReportListContainerEl.classList.add('hidden');
                if(calendarViewContainerEl) calendarViewContainerEl.classList.remove('hidden');
                reportViewCalendarBtnEl.classList.add('btn-primary');
                reportViewCalendarBtnEl.classList.remove('btn-secondary');
                if(reportViewListBtnEl) reportViewListBtnEl.classList.remove('btn-primary');
                if(reportViewListBtnEl) reportViewListBtnEl.classList.add('btn-secondary');
                if(calendarModeToggleContainerEl && currentUserProfile && currentUserProfile.role === MANAGER_ROLE) {
                     calendarModeToggleContainerEl.classList.remove('hidden'); 
                }
                renderCalendarView(); 
            });
        }
        if(prevMonthBtnEl) {
            prevMonthBtnEl.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendarView();
            });
        }
        if(nextMonthBtnEl) {
            nextMonthBtnEl.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendarView();
            });
        }
         if(calendarModeDeliveryBtnEl) {
            calendarModeDeliveryBtnEl.addEventListener('click', () => {
                currentReportCalendarType = 'delivery';
                calendarModeDeliveryBtnEl.classList.add('btn-primary');
                calendarModeDeliveryBtnEl.classList.remove('btn-secondary');
                if(calendarModeProductionBtnEl) calendarModeProductionBtnEl.classList.remove('btn-primary');
                if(calendarModeProductionBtnEl) calendarModeProductionBtnEl.classList.add('btn-secondary');
                renderCalendarView();
            });
        }
        if(calendarModeProductionBtnEl) {
            calendarModeProductionBtnEl.addEventListener('click', () => {
                currentReportCalendarType = 'production';
                calendarModeProductionBtnEl.classList.add('btn-primary');
                calendarModeProductionBtnEl.classList.remove('btn-secondary');
                if(calendarModeDeliveryBtnEl) calendarModeDeliveryBtnEl.classList.remove('btn-primary');
                if(calendarModeDeliveryBtnEl) calendarModeDeliveryBtnEl.classList.add('btn-secondary');
                renderCalendarView();
            });
        }

        // Notification Bell Listeners
        if (notificationBellBtnEl) {
            notificationBellBtnEl.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent body click from immediately closing
                if (notificationDropdownEl) notificationDropdownEl.classList.toggle('hidden');
            });
        }
        if (markAllNotificationsReadBtnEl) {
            markAllNotificationsReadBtnEl.addEventListener('click', (e) => {
                e.stopPropagation();
                markAllNotificationsAsRead();
            });
        }
        if (notificationListEl) {
            notificationListEl.addEventListener('click', (e) => {
                const item = e.target.closest('.notification-item');
                if (item) {
                    e.stopPropagation();
                    const notificationId = item.dataset.id;
                    const orderId = item.dataset.orderId;
                    const sectionTarget = item.dataset.section;

                    markNotificationAsRead(notificationId);
                    if (notificationDropdownEl) notificationDropdownEl.classList.add('hidden');

                    if (sectionTarget) {
                        const navButton = document.querySelector(`.nav-link[data-section="${sectionTarget}"]`);
                        if (navButton) navButton.click();
                    }
                    if (sectionTarget === 'allOrders' && orderId) {
                         if(orderFilterInputEl) orderFilterInputEl.value = orderId.substring(0,5);
                         renderAllOrdersTable();
                    } else if (sectionTarget === 'myQueue' && orderId) {
                        if(myQueueFilterInputEl) myQueueFilterInputEl.value = orderId.substring(0,5);
                        renderMyQueue();
                    } else if (sectionTarget === 'estimatesControl' && orderId) {
                         if(estimatesControlFilterInputEl) estimatesControlFilterInputEl.value = orderId.substring(0,5);
                        renderEstimatesControl();
                    }
                }
            });
        }
         // Close notification dropdown if clicked outside
        document.body.addEventListener('click', (e) => {
            if (notificationDropdownEl && !notificationDropdownEl.classList.contains('hidden')) {
                if (!notificationBellContainerEl.contains(e.target)) {
                    notificationDropdownEl.classList.add('hidden');
                }
            }
        });


        window.openOrderDetailsReportModal = async function(orderId) {
            const order = allOrdersCache.find(o => o.id === orderId);
            if (!order) {
                showGenericModal("Erro", "Pedido não encontrado.");
                return;
            }
            showLoading();

            if(reportClientNameEl) reportClientNameEl.textContent = order.clientName || 'N/A';
            if(reportOrderIdEl) reportOrderIdEl.textContent = order.id.substring(0,8) + "...";
            if(reportCreatedAtEl) reportCreatedAtEl.textContent = formatDateTime(order.createdAt); 
            if(reportProductionStartDateEl) reportProductionStartDateEl.textContent = order.productionStartDate ? formatDate(order.productionStartDate) : 'Não definida';
            if(reportDeliveryDateEl) reportDeliveryDateEl.textContent = formatDate(order.deliveryDate);
            if(reportPriorityEl) reportPriorityEl.innerHTML = `<span class="status-badge priority-${order.priority}">${(order.priority || 'normal').toUpperCase()}</span>`;
            if(reportOrderPhaseEl) reportOrderPhaseEl.innerHTML = `<span class="status-badge phase-${order.orderPhase || 'estimation'}">${getOrderPhaseText(order.orderPhase)}</span>`;
            if(reportOrderStatusEl) reportOrderStatusEl.innerHTML = `<span class="status-badge status-${order.status}">${getStatusText(order.status)}</span>`;
            if(reportDescriptionEl) reportDescriptionEl.textContent = order.description || 'Nenhuma observação.';

            if (reportCoverImageEl && reportCoverImageErrorEl) {
                if (order.coverImageUrl && order.coverImageUrl.trim() !== "") {
                    const imgData = await imageUrlToBase64(order.coverImageUrl);
                    if (imgData) {
                        reportCoverImageEl.src = imgData;
                        reportCoverImageEl.classList.remove('hidden');
                        reportCoverImageErrorEl.classList.add('hidden');
                    } else {
                        reportCoverImageEl.classList.add('hidden');
                        reportCoverImageErrorEl.textContent = `Falha ao carregar imagem. Verifique a URL, conexão e possíveis restrições de CORS do servidor da imagem. URL: ${order.coverImageUrl}`;
                        reportCoverImageErrorEl.classList.remove('hidden');
                    }
                } else {
                    reportCoverImageEl.classList.add('hidden');
                    reportCoverImageErrorEl.textContent = 'Nenhuma imagem de referência fornecida.';
                    reportCoverImageErrorEl.classList.remove('hidden');
                }
            }

            if (reportOrderItemsEl) {
                reportOrderItemsEl.innerHTML = '';
                if (order.items && order.items.length > 0) {
                    order.items.forEach(item => {
                        const itemP = document.createElement('p');
                        itemP.className = 'p-2 bg-gray-100 rounded';
                        itemP.textContent = `${item.quantity}x ${item.material} (${item.width}cm x ${item.height}cm)`;
                        reportOrderItemsEl.appendChild(itemP);
                    });
                } else {
                    reportOrderItemsEl.innerHTML = '<p class="text-gray-500 italic">Nenhum item especificado.</p>';
                }
            }

            if (reportSelectedStagesEl) {
                reportSelectedStagesEl.innerHTML = '';
                if (order.selectedStages && order.selectedStages.length > 0) {
                    order.selectedStages.forEach(stageKey => {
                        const stageLi = document.createElement('li');
                        stageLi.textContent = getStatusText(stageKey);
                        reportSelectedStagesEl.appendChild(stageLi);
                    });
                } else {
                    reportSelectedStagesEl.innerHTML = '<li class="text-gray-500 italic">Nenhuma etapa de produção selecionada.</li>';
                }
            }

            if (reportDetailedTimelineEl) {
                reportDetailedTimelineEl.innerHTML = '';
                if (order.timeline && order.selectedStages && order.selectedStages.length > 0) {
                    order.selectedStages.forEach(stageKey => {
                        const stageDetail = order.timeline[stageKey] || {};
                        const stageDiv = document.createElement('div');
                        stageDiv.className = 'p-3 border rounded-md bg-gray-50';
                        stageDiv.innerHTML = `
                            <h5 class="font-semibold text-gray-700">${getStatusText(stageKey)}</h5>
                            <p class="text-xs text-gray-600">Estimativa Enviada: <span class="font-medium">${stageDetail.estimationSubmittedAt ? formatDateTime(stageDetail.estimationSubmittedAt) : 'Pendente'}</span></p>
                            <p class="text-xs text-gray-600">Tempo Estimado: <span class="font-medium">${formatTime(stageDetail.estimatedMinutes)}</span></p>
                            ${(order.orderPhase === 'production' || order.orderPhase === 'completed') ? `
                                <p class="text-xs text-gray-600">Início Etapa: <span class="font-medium">${stageDetail.productionStartTime ? formatDateTime(stageDetail.productionStartTime) : 'N/A'}</span></p>
                                <p class="text-xs text-gray-600">Fim Etapa: <span class="font-medium">${stageDetail.productionEndTime ? formatDateTime(stageDetail.productionEndTime) : (order.status === stageKey && order.orderPhase === 'production' ? 'Em Andamento' : 'Pendente')}</span></p>
                                <p class="text-xs text-gray-600">Tempo Real Gasto: <span class="font-medium">${formatTime(stageDetail.actualMinutes)}</span></p>
                            ` : ''}
                        `;
                        reportDetailedTimelineEl.appendChild(stageDiv);
                    });
                } else {
                    reportDetailedTimelineEl.innerHTML = '<p class="text-gray-500 italic">Nenhum detalhe de tempo disponível.</p>';
                }
            }
            
            if (reportQCTableBodyEl) {
                reportQCTableBodyEl.innerHTML = '';
                const qcItems = [
                    "Visual (impressão)", "Resina (espessura/defeitos)", "Corte (acabamento/borda)",
                    "Conferência de quantidade", "Embalagem final"
                ];
                qcItems.forEach(itemText => {
                    const row = reportQCTableBodyEl.insertRow();
                    row.innerHTML = `
                        <td class="p-2 border border-gray-300">${itemText}</td>
                        <td class="p-2 border border-gray-300 h-10"></td>
                        <td class="p-2 border border-gray-300 h-10"></td>
                        <td class="p-2 border border-gray-300 h-10"></td>
                        <td class="p-2 border border-gray-300 h-10"></td>
                    `;
                });
            }

            if(orderDetailsReportModalEl) orderDetailsReportModalEl.classList.remove('hidden');
            hideLoading();
        }

        window.closeOrderDetailsReportModal = function() {
            if(orderDetailsReportModalEl) orderDetailsReportModalEl.classList.add('hidden');
            if(reportCoverImageEl) reportCoverImageEl.src = '';
            if(reportCoverImageEl) reportCoverImageEl.classList.add('hidden');
            if(reportCoverImageErrorEl) reportCoverImageErrorEl.classList.add('hidden');
        }

        window.showDailyLoadDetailsModal = function(date, orders, viewType = 'delivery') {
            if (!dailyLoadDetailsModalEl || !dailyLoadDetailsModalTitleEl || !dailyLoadDetailsModalBodyEl) {
                console.error("[DEBUG] Elementos do modal de carga diária não encontrados.");
                return;
            }
            
            const modalTitlePrefix = viewType === 'production' ? "Pedidos com Início de Produção em" : "Pedidos para Entrega em";
            dailyLoadDetailsModalTitleEl.textContent = `${modalTitlePrefix} ${formatDate(date)}`;
            
            if (orders && orders.length > 0) {
                let tableHeaders = `
                    <th class="p-2 border border-gray-300 text-left">ID do Pedido</th>
                    <th class="p-2 border border-gray-300 text-left">Cliente</th>
                    <th class="p-2 border border-gray-300 text-left">Tempo Estimado</th>
                `;
                if (viewType === 'production') {
                    tableHeaders += `<th class="p-2 border border-gray-300 text-left">Data Entrega</th>`;
                } else { // delivery
                    tableHeaders += `<th class="p-2 border border-gray-300 text-left">Início Produção</th>`;
                }


                dailyLoadDetailsModalBodyEl.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>${tableHeaders}</tr>
                            </thead>
                            <tbody>
                                ${orders.map(order => {
                                    let complementaryDateCell = '';
                                    if (viewType === 'production') {
                                        complementaryDateCell = `<td class="p-2 border border-gray-200">${formatDate(order.deliveryDate)}</td>`;
                                    } else { // delivery
                                        complementaryDateCell = `<td class="p-2 border border-gray-200">${order.productionStartDate ? formatDate(order.productionStartDate) : 'N/A'}</td>`;
                                    }
                                    return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="p-2 border border-gray-200 font-mono text-xs">${order.id.substring(0,8)}...</td>
                                            <td class="p-2 border border-gray-200">${order.clientName}</td>
                                            <td class="p-2 border border-gray-200">${formatTime(order.estimatedTime)}</td>
                                            ${complementaryDateCell}
                                        </tr>
                                    `
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                dailyLoadDetailsModalBodyEl.innerHTML = '<p class="text-gray-500 italic">Nenhum pedido encontrado para esta data.</p>';
            }
            dailyLoadDetailsModalEl.classList.remove('hidden');
        }

        window.closeDailyLoadDetailsModal = function() {
            if(dailyLoadDetailsModalEl) dailyLoadDetailsModalEl.classList.add('hidden');
        }

        function toggleOrderSelectionMode(shouldRenderTable = true) {
            isOrderSelectionModeActive = !isOrderSelectionModeActive;
            selectedOrdersForDeletion.clear(); 

            if (toggleOrderSelectionModeBtnEl) {
                toggleOrderSelectionModeBtnEl.textContent = isOrderSelectionModeActive ? 'Cancelar Seleção' : 'Selecionar para Excluir';
                toggleOrderSelectionModeBtnEl.classList.toggle('btn-warning', !isOrderSelectionModeActive);
                toggleOrderSelectionModeBtnEl.classList.toggle('btn-secondary', isOrderSelectionModeActive);
            }
            if (deleteSelectedOrdersBtnEl) {
                deleteSelectedOrdersBtnEl.classList.toggle('hidden', !isOrderSelectionModeActive);
                deleteSelectedOrdersBtnEl.disabled = true; 
                deleteSelectedOrdersBtnEl.textContent = 'Excluir Selecionados';
            }
            if (shouldRenderTable) {
                renderAllOrdersTable(); 
            }
        }

        if (toggleOrderSelectionModeBtnEl) {
            toggleOrderSelectionModeBtnEl.addEventListener('click', () => toggleOrderSelectionMode(true));
        }

        if (deleteSelectedOrdersBtnEl) {
            deleteSelectedOrdersBtnEl.addEventListener('click', deleteSelectedOrdersFromDb);
        }

        async function callGeminiApiForDescription(prompt) {
            if (generateDescriptionBtnEl) {
                const btnText = generateDescriptionBtnEl.querySelector('.btn-text');
                const btnSpinner = generateDescriptionBtnEl.querySelector('.btn-loading-spinner');
                if (btnText) btnText.classList.add('hidden');
                if (btnSpinner) btnSpinner.classList.remove('hidden');
                generateDescriptionBtnEl.disabled = true;
            }

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // ADD YOUR GEMINI API KEY HERE
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("Erro da API Gemini:", response.status, errorBody);
                    showGenericModal("Erro da IA", `Não foi possível gerar a descrição (HTTP ${response.status}). Verifique o console para detalhes.`);
                    return null;
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Resposta inesperada da API Gemini:", result);
                    showGenericModal("Erro da IA", "Resposta inesperada ao gerar descrição. Verifique o console.");
                    return null;
                }
            } catch (error) {
                console.error("Erro ao chamar API Gemini:", error);
                showGenericModal("Erro de Conexão com IA", "Não foi possível conectar à API para gerar a descrição. Verifique sua conexão e o console.");
                return null;
            } finally {
                if (generateDescriptionBtnEl) {
                    const btnText = generateDescriptionBtnEl.querySelector('.btn-text');
                    const btnSpinner = generateDescriptionBtnEl.querySelector('.btn-loading-spinner');
                    if (btnText) btnText.classList.remove('hidden');
                    if (btnSpinner) btnSpinner.classList.add('hidden');
                    generateDescriptionBtnEl.disabled = false;
                }
            }
        }

        if (generateDescriptionBtnEl) {
            generateDescriptionBtnEl.addEventListener('click', async () => {
                const clientName = document.getElementById('clientName')?.value || "";
                const priority = document.getElementById('priority')?.value || "";
                
                const items = [];
                const itemCards = orderItemsContainerEl.querySelectorAll('.card');
                itemCards.forEach(card => {
                    const material = card.querySelector('input[name="item_material"]')?.value;
                    const quantity = card.querySelector('input[name="item_quantity"]')?.value;
                    const width = card.querySelector('input[name="item_width"]')?.value;
                    const height = card.querySelector('input[name="item_height"]')?.value;
                    if (material && quantity && width && height) {
                        items.push(`- ${quantity}x ${material} (${width}cm x ${height}cm)`);
                    }
                });
                const itemsString = items.join('\n');

                if (!clientName && items.length === 0) {
                    showGenericModal("Atenção", "Preencha o nome do cliente ou adicione itens para gerar uma descrição.");
                    return;
                }

                let prompt = `Gere uma breve descrição para um pedido de produção para o cliente "${clientName}".\n`;
                if (priority) {
                    prompt += `Prioridade do pedido: ${priority}.\n`;
                }
                if (items.length > 0) {
                    prompt += `Itens do pedido:\n${itemsString}\n`;
                }
                prompt += `A descrição deve ser concisa e adequada para um campo de observações, resumindo os pontos chave do pedido.`;

                console.log("[DEBUG] Prompt para Gemini:", prompt);
                const generatedDescription = await callGeminiApiForDescription(prompt);

                if (generatedDescription && descriptionTextAreaEl) {
                    descriptionTextAreaEl.value = generatedDescription;
                }
            });
        }

        window.openEditOrderDatesModal = function(orderId) {
            if (!currentUserProfile || currentUserProfile.role !== MANAGER_ROLE) {
                showGenericModal("Acesso Negado", "Apenas gerentes podem editar datas de pedidos.");
                return;
            }
            const order = allOrdersCache.find(o => o.id === orderId);
            if (!order) {
                showGenericModal("Erro", "Pedido não encontrado.");
                return;
            }

            if (editOrderIdInputEl) editOrderIdInputEl.value = orderId;
            if (editProductionStartDateInputEl) editProductionStartDateInputEl.value = order.productionStartDate || '';
            if (editDeliveryDateInputEl) editDeliveryDateInputEl.value = order.deliveryDate || '';
            
            const today = new Date().toISOString().split("T")[0];
            if (editProductionStartDateInputEl) editProductionStartDateInputEl.min = today;
            if (editDeliveryDateInputEl) editDeliveryDateInputEl.min = today;


            if (editOrderDatesModalEl) editOrderDatesModalEl.classList.remove('hidden');
        }

        window.closeEditOrderDatesModal = function() {
            if (editOrderDatesModalEl) editOrderDatesModalEl.classList.add('hidden');
        }

        async function saveOrderDates() {
            if (!editOrderIdInputEl || !editProductionStartDateInputEl || !editDeliveryDateInputEl) return;

            const orderId = editOrderIdInputEl.value;
            const newProductionStartDate = editProductionStartDateInputEl.value;
            const newDeliveryDate = editDeliveryDateInputEl.value;

            if (!orderId) {
                showGenericModal("Erro", "ID do pedido não encontrado para salvar as datas.");
                return;
            }
            if (!newProductionStartDate && !newDeliveryDate) {
                showGenericModal("Atenção", "Nenhuma nova data foi fornecida.");
                return;
            }

            const updateData = {};
            if (newProductionStartDate) updateData.productionStartDate = newProductionStartDate;
            if (newDeliveryDate) updateData.deliveryDate = newDeliveryDate;

            showLoading();
            try {
                const orderRef = doc(ordersCollectionRef, orderId);
                await updateDoc(orderRef, updateData);
                showToast("Datas do pedido atualizadas!", "success");
                closeEditOrderDatesModal();
            } catch (error) {
                console.error("Erro ao salvar datas do pedido:", error);
                showGenericModal("Erro", "Não foi possível salvar as alterações nas datas do pedido.");
            } finally {
                hideLoading();
            }
        }
        if(saveOrderDatesBtnEl) saveOrderDatesBtnEl.addEventListener('click', saveOrderDates);


        document.addEventListener('DOMContentLoaded', function() {
            console.log("[DEBUG] DOM Content Loaded - Iniciando configuração da UI");
            const deliveryDateInput = document.getElementById('deliveryDate');
            if(deliveryDateInput) deliveryDateInput.min = new Date().toISOString().split("T")[0];
            
            if (loginSectionEl) loginSectionEl.classList.remove('hidden');
            if (appContentEl) appContentEl.classList.add('hidden');
            if (userInfoEl) userInfoEl.classList.add('hidden');
            if(notificationBellContainerEl) notificationBellContainerEl.classList.add('hidden');
            console.log("[DEBUG] DOMContentLoaded: Estado inicial da UI configurado para login.");
        });
        console.log("[DEBUG] End of script module reached.");
    </script>
</body>
</html>